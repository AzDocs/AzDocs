{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Regulatory Compliance Dashboard v2",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "azure security center",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Regulatory Compliance Dashboard\\n\"},\"customWidth\":\"50\",\"name\":\"text - 0\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::tenant\"],\"parameters\":[{\"id\":\"f9604af0-6426-4c26-8149-974950332bc5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_set_definition_name\",\"label\":\"Policy Set\",\"type\":2,\"description\":\"Regulatory compliance policy definitions with at least one assigment in the current tenant\",\"isRequired\":true,\"query\":\"policyresources\\n| where type =~'Microsoft.Authorization/PolicyAssignments'\\n| extend policy_assignment_id = tolower(tostring(id))\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| join kind=inner \\n(\\n policyresources\\n | where type =~'Microsoft.Authorization/PolicySetDefinitions' \\n | extend policy_set_definition_id = tolower(id)\\n | extend policy_set_definition_display_name = tostring(properties.displayName)\\n | project policy_set_definition_id, policy_set_definition_display_name\\n) on $left.policy_definition_id == $right.policy_set_definition_id\\n| extend s = split(policy_set_definition_id, '/')\\n| extend l = array_length(s)\\n| extend policy_set_definition_name = tolower(s[l-1])\\n| distinct policy_set_definition_name, policy_set_definition_display_name\\n| order by policy_set_definition_display_name\\n| project Id=policy_set_definition_name, Label=policy_set_definition_display_name, Selected=true\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"value\":\"alerting-management\"},{\"id\":\"3a5cac74-b8a9-4908-8492-0e4eb7cb6486\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_assignment\",\"label\":\"Assignment\",\"type\":2,\"isRequired\":true,\"query\":\"policyresources\\n| where type =~'Microsoft.Authorization/PolicyAssignments'\\n| where properties.policyDefinitionId endswith '{_policy_set_definition_name}'\\n| extend policy_assignment_id = tolower(tostring(id))\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| extend policy_assignment_details = tostring(pack_all())\\n| extend scope = tolower(tostring(properties.scope))\\n| join ( \\n resourcecontainers\\n | project id=tolower(id), container_name=name\\n) on $left.scope == $right.id\\n| extend scope_s = split(scope, '/')\\n| project Id=policy_assignment_id, Assignment = container_name, selected=true\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"c998dd33-b990-45c8-9987-dabc646178d6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_subscriptions\",\"label\":\"Subscriptions\",\"type\":6,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources\\n| where type == \\\"microsoft.policyinsights/policystates\\\"\\n| where properties.policyAssignmentId == '{_assignment}'\\n| extend subscription_id=tolower(subscriptionId)\\n| join ( \\n resourcecontainers\\n | where type == \\\"microsoft.resources/subscriptions\\\"\\n | where properties.state =~ 'Enabled'\\n | project subscription_id=tolower(subscriptionId), subscription_name=name\\n) on subscription_id\\n| distinct subscription_id, subscription_name\\n| project Id=subscription_id, Label=subscription_name, Selected=true\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"96a8e5e5-ee6a-4e10-809d-007b71b1335d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_set_definition_id\",\"type\":1,\"isRequired\":true,\"query\":\"policyresources \\n| where type == \\\"microsoft.authorization/policyassignments\\\"\\n| where id =~ '{_assignment}' // selector\\n| extend policy_set_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| project policy_set_definition_id\",\"crossComponentResources\":[\"value::tenant\"],\"isHiddenWhenLocked\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"f42891a8-4a24-4983-aa22-76d46a8db074\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_assignment_scope\",\"type\":1,\"isRequired\":true,\"query\":\"policyresources\\n| where type =~'Microsoft.Authorization/PolicyAssignments'\\n| extend policy_assignment_id = tolower(tostring(id))\\n| where policy_assignment_id == '{_assignment}'\\n| extend scope = tolower(tostring(properties.scope))\\n| project scope\",\"crossComponentResources\":[\"value::tenant\"],\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"78884f94-5066-4b1a-b8eb-50f0b2a0d7d6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_template_version\",\"type\":1,\"description\":\"format: 0.0.0.0\",\"isRequired\":true,\"isHiddenWhenLocked\":true,\"value\":\"2.0.4.0\"},{\"id\":\"4bb1099f-4571-473d-8e7b-89a13084ba33\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_selected_tab\",\"type\":1,\"isGlobal\":true,\"isHiddenWhenLocked\":true,\"timeContext\":{\"durationMs\":86400000},\"value\":\"overview\"},{\"id\":\"ac1ab9ac-f6e3-4baa-9e5f-a6f2179d95f7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_exclude_reasons\",\"label\":\"Exclude Reasons\",\"type\":2,\"description\":\"Exclude states with specific NonCompliant reasons from results\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n | where policy_assignment_id == '{_assignment}'\\n | extend state_weight = toint(properties.stateWeight)\\n | where  state_weight == 300 //noncompliant\\n | extend compliance_reason=tostring(properties.complianceReasonCode)\\n | distinct compliance_reason\\n | where notempty(compliance_reason)\\n | order by compliance_reason asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"value\":[]}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},\"customWidth\":\"50\",\"name\":\"parameters-main\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"19b70739-ff6f-437e-bcb6-57076bb20155\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Overview\",\"subTarget\":\"overview\",\"preText\":\"\",\"style\":\"link\"},{\"id\":\"5575c357-016f-4c30-a367-ca6601e8ade4\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"By Control\",\"subTarget\":\"by_control\",\"style\":\"link\"},{\"id\":\"401634b1-9eab-4cc4-93b3-72f7c7d7d807\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"By Policy Definition\",\"subTarget\":\"by_policy_definition\",\"style\":\"link\"},{\"id\":\"7efe46d5-644c-4dd0-b1a2-a5e7b9970a12\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"By Resource\",\"subTarget\":\"by_resource\",\"style\":\"link\"},{\"id\":\"c2ad1ae9-1507-4429-9e68-3f3d479fa7c7\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Exempts\",\"subTarget\":\"exempts\",\"style\":\"link\"},{\"id\":\"bd65714b-5b8a-404a-8ed2-439588abdac6\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Assignment\",\"subTarget\":\"assignment\",\"style\":\"link\"},{\"id\":\"c3eaca3c-0575-4453-8b0b-44d5a953f95d\",\"cellValue\":\"_selected_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Export\",\"subTarget\":\"export\",\"style\":\"link\"}]},\"name\":\"links - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"### Policy Compliance Status\\nConsolidated compliance status of controls, policies and resources in the context of the selected policy set.\"},\"name\":\"text - compliance_status\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend state_weight = toint(properties.stateWeight)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n| mv-expand policy_definition_group_names limit 2000\\n| extend policy_definition_group_name = tolower(tostring(policy_definition_group_names))\\n| summarize max_state_weight=max(state_weight) by policy_definition_group_name\\n| summarize counts = count() by max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\\n| project compliance_state, counts\",\"size\":4,\"title\":\"By Control\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"counts\"],\"seriesLabelSettings\":[{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"},{\"seriesName\":\"\",\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - control_compliance_status\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend state_weight = toint(properties.stateWeight)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend state_weight = toint(properties.stateWeight)\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| summarize max_state_weight=max(state_weight) by policy_definition_id\\n| summarize counts = count() by max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\\n| project compliance_state, counts \\n\\n\\n \",\"size\":4,\"title\":\"By Policy Definition\",\"noDataMessage\":\"No policies where found with recommendation severity Medium\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"compliance_state\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"counts\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"compliance_state\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"counts\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"},{\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - policy_compliance_status\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend state_weight = toint(properties.stateWeight)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_set_definition_id = tolower(properties.policySetDefinitionId)\\n| extend state_weight = toint(properties.stateWeight)\\n| extend resource_id = tolower(tostring(properties.resourceId))\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| summarize max_state_weight=max(state_weight) by resource_id\\n| summarize counts = count() by  max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\\n| project compliance_state, counts \\n\\n\\n \",\"size\":4,\"title\":\"By Resource\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"},{\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - resource_compliance_status\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 7\"},{\"type\":1,\"content\":{\"json\":\"### Policy Compliance Status By Microsoft Defender for Cloud Recommendation Severity\\nSummarizes policy compliance status by Microsoft Defender for Cloud Recommendation Severities in the context of the selected policy set.\"},\"name\":\"text - compliance_status - severities\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| extend state_weight = toint(properties.stateWeight)\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| summarize max_state_weight=max(state_weight) by policy_definition_id\\n| join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(tostring(properties.metadata.policyDefinitionId))\\n    | extend severity=tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize  severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n    ) on policy_definition_id\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| where severity =~ 'high'\\n| summarize counts = count() by max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\",\"size\":4,\"title\":\"High Severity\",\"noDataMessage\":\"No policies where found with recommendation severity High\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"counts\"],\"group\":\"compliance_state\",\"createOtherGroup\":null,\"seriesLabelSettings\":[{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"},{\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - high_severity_security_recommendations\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| extend state_weight = toint(properties.stateWeight)\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| summarize max_state_weight=max(state_weight) by policy_definition_id\\n| join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(tostring(properties.metadata.policyDefinitionId))\\n    | extend severity=tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize  severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n    ) on policy_definition_id\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| where severity =~ 'medium'\\n| summarize counts = count() by max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\",\"size\":4,\"title\":\"Medium Severity\",\"noDataMessage\":\"No recommendations where found with severity Medium\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"counts\"],\"group\":\"compliance_state\",\"createOtherGroup\":null,\"seriesLabelSettings\":[{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"},{\"seriesName\":\"\",\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"name\":\"query - medium_severity_security_recommendations\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| extend state_weight = toint(properties.stateWeight)\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| summarize max_state_weight=max(state_weight) by policy_definition_id\\n| join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(tostring(properties.metadata.policyDefinitionId))\\n    | extend severity=tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize  severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n    ) on policy_definition_id\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| where severity =~ 'low'\\n| summarize counts = count() by max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\",\"size\":4,\"title\":\"Low Severity\",\"noDataMessage\":\"No policies where found with recommendation severity Low\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"counts\"],\"group\":\"compliance_state\",\"createOtherGroup\":null,\"seriesLabelSettings\":[{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"\",\"color\":\"blue\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"}]}},\"customWidth\":\"33\",\"name\":\"query - low_severity_security_recommendations\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId))\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| extend state_weight = toint(properties.stateWeight)\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| summarize max_state_weight=max(state_weight) by policy_definition_id\\n| join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(tostring(properties.metadata.policyDefinitionId))\\n    | extend severity=tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize  severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n    ) on policy_definition_id\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| where severity =~ 'Unknown'\\n| summarize counts = count() by max_state_weight\\n| extend compliance_state = case (\\n max_state_weight == 300, 'noncompliant',\\n max_state_weight == 200, 'compliant',\\n max_state_weight == 150, 'error',\\n max_state_weight == 100, 'conflict',\\n max_state_weight == 75, 'protected',\\n max_state_weight == 50, 'exempt',\\n max_state_weight == 10, 'unknown',\\n max_state_weight == 0,'notapplicable', \\n 'notapplicable'\\n)\",\"size\":4,\"title\":\"Unknown Severity\",\"noDataMessage\":\"No policies where found with recommendation severity Unknown\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"piechart\",\"chartSettings\":{\"yAxis\":[\"counts\"],\"group\":\"compliance_state\",\"createOtherGroup\":null,\"seriesLabelSettings\":[{\"seriesName\":\"noncompliant\",\"color\":\"redBright\"},{\"seriesName\":\"compliant\",\"color\":\"green\"},{\"seriesName\":\"\",\"color\":\"blue\"},{\"seriesName\":\"exempt\",\"color\":\"gray\"}]}},\"customWidth\":\"33\",\"name\":\"query - unknown_severity_security_recommendations\"},{\"type\":1,\"content\":{\"json\":\"\"},\"name\":\"text - 10\"}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"overview\"},\"name\":\"group - overview\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::tenant\"],\"parameters\":[{\"id\":\"d70da459-ef3b-4a90-bf8b-cc8f2973e7d9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_controls\",\"label\":\"Controls\",\"type\":2,\"description\":\"Only shows controls that have a policy attached with targeted resources. (list can differ per environment)\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n | where policy_assignment_id == '{_assignment}' // selector\\n | extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n | mv-expand policy_definition_group_names\\n | extend policy_definition_group_name = tolower(tostring(policy_definition_group_names))\\n | distinct policy_definition_group_name\\n | order by policy_definition_group_name asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"all_controls\",\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"value\":[\"value::all\"]},{\"id\":\"7e689d69-4082-4481-8175-aaddaebeb5bf\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_resource_compliance\",\"label\":\"Resource Compliance\",\"type\":2,\"description\":\"Filter resources by compliance state. By default compliant resources are filtered out.\",\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\n {\\n \\\"label\\\": \\\"compliant\\\",\\n \\\"value\\\": \\\"200\\\",\\n \\\"selected\\\": false\\n },\\n {\\n \\\"label\\\": \\\"noncompliant\\\",\\n \\\"value\\\": \\\"300\\\",\\n \\\"selected\\\": true \\n },\\n {\\n \\\"label\\\": \\\"exempt\\\",\\n \\\"value\\\": \\\"50\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"error\\\",\\n  \\\"value\\\": \\\"150\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"conflict\\\",\\n \\\"value\\\": \\\"100\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"protected\\\",\\n  \\\"value\\\": \\\"75\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"unknown\\\",\\n \\\"value\\\": \\\"10\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"notapplicable\\\",\\n \\\"value\\\": \\\"0\\\",\\n \\\"selected\\\": false \\n }\\n]\\n\\n\\n\\n\\n\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},\"name\":\"parameters - 0 - Copy\",\"styleSettings\":{\"margin\":\"0px\",\"padding\":\"0px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// resource details\\npolicyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tostring(properties.policyAssignmentId)\\n| where policy_assignment_id =~ '{_assignment}' \\n| extend subscription_id = tostring(properties.subscriptionId)\\n| where subscription_id in~ ({_subscriptions:subid}) \\n| extend state_weight = toint(properties.stateWeight)\\n| where  tostring(state_weight) == '{_resource_compliance}' \\n| extend resource_id = tostring(properties.resourceId)\\n| extend resource_type = tostring(properties.resourceType)\\n| extend last_updated = tostring(properties.timestamp)\\n| extend policy_definition_id = tolower(properties.policyDefinitionId)\\n| extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n| mv-expand policy_definition_group_names limit 2000\\n| extend policy_definition_group_name = tolower(policy_definition_group_names)\\n| where 'all_controls' in ({_controls}) or policy_definition_group_name in~ ({_controls}) \\n| summarize state_weight=arg_max(state_weight, *), subscription_list=make_set(subscription_id) by policy_definition_group_name, policy_definition_id, resource_id \\n| where  tostring(state_weight) =~ '{_resource_compliance}' \\n| extend name = resource_id\\n| extend id = strcat(policy_definition_group_name,policy_definition_id, resource_id)\\n| extend parent_id = strcat(policy_definition_group_name, policy_definition_id)\\n| extend category = 'resource'\\n| union (\\n// policy details\\n policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend policy_assignment_id = tostring(properties.policyAssignmentId)\\n | where policy_assignment_id =~ '{_assignment}' \\n | extend subscription_id = tostring(properties.subscriptionId)\\n | where subscription_id in~ ({_subscriptions:subid}) \\n | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n | extend resource_id = tostring(properties.resourceId)\\n | extend state_weight = toint(properties.stateWeight)\\n | extend policy_definition_id = tolower(properties.policyDefinitionId)\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n | where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n | join kind=leftouter \\n (\\n    policyresources \\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_display_name=tostring(properties.displayName)\\n    | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n    | project policy_definition_id, policy_definition_display_name, policy_definition_ref_id\\n ) on policy_definition_id\\n | extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n | mv-expand policy_definition_group_names limit 2000\\n | extend policy_definition_group_name = tolower(policy_definition_group_names)\\n | where 'all_controls' in ({_controls}) or policy_definition_group_name in~ ({_controls}) \\n | summarize state_weight=arg_max(state_weight, *), subscription_list=make_set(subscription_id), total_resources=countif(tostring(state_weight) in~ ({_resource_compliance})) by policy_definition_group_name, policy_definition_id\\n | where total_resources > 0\\n | extend name = policy_definition_display_name\\n | extend id = strcat(policy_definition_group_name, policy_definition_id)\\n | extend parent_id = strcat(policy_definition_group_name)\\n | extend category='policy'\\n // get assessment severity\\n | join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(properties.metadata.policyDefinitionId)\\n    | extend severity = tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n) on policy_definition_id\\n)\\n// control details\\n| union (\\n policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend policy_assignment_id = tostring(properties.policyAssignmentId)\\n | where policy_assignment_id =~ '{_assignment}' \\n | extend subscription_id = tostring(properties.subscriptionId)\\n | where subscription_id in~ ({_subscriptions:subid}) \\n | extend resource_id = tostring(properties.resourceId)\\n | extend state_weight = toint(properties.stateWeight)\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n | where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n | extend policy_definition_id = tolower(properties.policyDefinitionId)\\n | extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n | mv-expand policy_definition_group_names limit 2000\\n | extend policy_definition_group_name = tolower(policy_definition_group_names)\\n | where 'all_controls' in ({_controls}) or policy_definition_group_name in~ ({_controls}) \\n | summarize state_weight=arg_max(state_weight, *), total_resources=countif(tostring(state_weight) in~ ({_resource_compliance}))  by policy_definition_group_name \\n | where total_resources > 0\\n | summarize state_weight=arg_max(state_weight, *)  by policy_definition_group_name\\n | extend name = policy_definition_group_name\\n | extend id = policy_definition_group_name\\n | extend parent_id = ''\\n | extend category = 'group'\\n)\\n| extend compliance_state = case (\\n    state_weight == 300, 'noncompliant',\\n    state_weight == 200, 'compliant',\\n    state_weight == 150, 'error',\\n    state_weight == 100, 'conflict',\\n    state_weight == 75, 'protected',\\n    state_weight == 50, 'exempt',\\n    state_weight == 10, 'unknown',\\n    state_weight == 0,'notapplicable', \\n    'notapplicable'\\n )\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| extend severity = iff(category == 'group' or category == 'resource', '', severity)\\n| extend subscription_id = iff(category == 'group' or category == 'policy', '', subscription_id)\\n| extend compliance_reason = iff(category == 'group' or category == 'policy', '', compliance_reason)\\n| project-away state_weight\\n// minimize return payload size\\n| extend policy_definition_id = split(policy_definition_id, '/')[-1]\\n| extend id = hash_md5(strcat(id))\\n| extend parent_id = hash_md5(parent_id)\\n| project id, parent_id, name, compliance_state, total_resources, compliance_reason, severity, last_updated, subscription_id, subscription_list, assessment_key, category, resource_id, policy_definition_ref_id, policy_definition_id, policy_definition_group_name\\n| order by name asc\\n\",\"size\":0,\"title\":\"Compliance\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"resource_id\",\"parameterName\":\"_selected_resource_id\",\"parameterType\":1},{\"fieldName\":\"category\",\"parameterName\":\"_selected_category\",\"parameterType\":1},{\"fieldName\":\"compliance_state\",\"parameterName\":\"_selected_compliance_state\",\"parameterType\":1},{\"fieldName\":\"policy_definition_id\",\"parameterName\":\"_selected_policy_definition_id\",\"parameterType\":1},{\"fieldName\":\"policy_definition_ref_id\",\"parameterName\":\"_selected_policy_definition_ref_id\",\"parameterType\":1},{\"fieldName\":\"policy_set_definition_id\",\"parameterName\":\"_selected_policy_set_definition_id\",\"parameterType\":1},{\"fieldName\":\"policy_definition_group_name\",\"parameterName\":\"_selected_policy_definition_group_name\",\"parameterType\":1},{\"fieldName\":\"subscription_list\",\"parameterName\":\"_selected_subscription_list\",\"parameterType\":1},{\"fieldName\":\"assessment_key\",\"parameterName\":\"_selected_assessment_key\",\"parameterType\":1},{\"fieldName\":\"severity\",\"parameterName\":\"_selected_severity\",\"parameterType\":1}],\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":5},{\"columnMatch\":\"parent_id\",\"formatter\":5},{\"columnMatch\":\"name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"120ch\"}},{\"columnMatch\":\"compliance_state\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"compliant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"noncompliant\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"exempt\",\"representation\":\"stopped\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"total_resources\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"10ch\"}},{\"columnMatch\":\"compliance_reason\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"18ch\"}},{\"columnMatch\":\"severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Unknown\",\"representation\":\"Sev3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Ellipsis\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"last_updated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"subscription_id\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"subscription_list\",\"formatter\":5},{\"columnMatch\":\"assessment_key\",\"formatter\":5,\"formatOptions\":{\"bladeOpenContext\":{\"bladeName\":\"GenericRecommendationDetailsBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"assessmentKey\",\"source\":\"column\",\"value\":\"assessment_key\"},{\"name\":\"subscriptionIds\",\"source\":\"column\",\"value\":\"subscription_id\"},{\"name\":\"showSecurityCenterCommandBar~\",\"source\":\"static\",\"value\":\"false\"},{\"name\":\"assessmentOwners~\",\"source\":\"static\",\"value\":\"null\"}]}}},{\"columnMatch\":\"category\",\"formatter\":5},{\"columnMatch\":\"policy_definition_id\",\"formatter\":5},{\"columnMatch\":\"policy_definition_group_name\",\"formatter\":5},{\"columnMatch\":\"resource_type\",\"formatter\":16,\"formatOptions\":{\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"policy_set_definition_id\",\"formatter\":5},{\"columnMatch\":\"subscriptions_scope\",\"formatter\":5},{\"columnMatch\":\"policy_assignment_id\",\"formatter\":5},{\"columnMatch\":\"resource_group\",\"formatter\":5},{\"columnMatch\":\"state_weight\",\"formatter\":5}],\"rowLimit\":10000,\"hierarchySettings\":{\"idColumn\":\"id\",\"parentColumn\":\"parent_id\",\"treeType\":0,\"expanderColumn\":\"name\"},\"labelSettings\":[{\"columnId\":\"name\",\"label\":\"Name\"},{\"columnId\":\"compliance_state\",\"label\":\"Compliance State\"},{\"columnId\":\"total_resources\",\"label\":\"Total\"},{\"columnId\":\"compliance_reason\",\"label\":\"Reason\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"last_updated\",\"label\":\"Last Updated\"},{\"columnId\":\"subscription_id\",\"label\":\"Subscription\"}]}},\"name\":\"query - by_control\",\"styleSettings\":{\"margin\":\"0px\",\"padding\":\"0px\",\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.policyinsights/policystates\\\"\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend resource_id = tostring(properties.resourceId)\\n| where resource_id =~ '{_selected_resource_id}'\\n| extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n| where policy_definition_ref_id =~ '{_selected_policy_definition_ref_id}'\\n| where properties.complianceState == 'Exempt'\\n| extend subscription_id = tolower(subscriptionId)\\n| extend resource_group = resourceGroup\\n| extend policy_definition_id = tolower(tostring(properties.policySetDefinitionId))\\n// Get management group chain for resource \\n| join kind=leftouter ( \\n    resourcecontainers\\n    | where type =~ 'microsoft.resources/subscriptions'\\n    | extend subscription_id = tolower(split(id, '/')[2])\\n    | mv-expand managment_group_chain=properties.managementGroupAncestorsChain\\n    | summarize managment_group_chain=make_set(managment_group_chain.name) by subscription_id\\n) on subscription_id\\n// Get exempts for policy assignment\\n| join kind=leftouter (\\n    policyresources\\n    | where type == \\\"microsoft.authorization/policyexemptions\\\"\\n    | extend exempt_expires_on = todatetime(properties.expiresOn)\\n    // Filter out expired exempts\\n    | where isempty(exempt_expires_on) or exempt_expires_on > now()\\n    | extend exempt_id = id\\n    | extend exempt_subscription_id = subscriptionId\\n    | extend exempt_resource_group = resourceGroup\\n    | extend exempt_policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n    | extend exempt_policy_definition_ref_ids = todynamic(properties.policyDefinitionReferenceIds)\\n    | extend exempt_category = tostring(properties.exemptionCategory)\\n    | extend exempt_display_name = tostring(properties.displayName)\\n    | extend exempt_description = tostring(properties.description)\\n    | extend exempt_scope = tostring(split(id, '/providers/Microsoft.Authorization')[0])\\n    | extend exempt_management_group = iff(id has '/providers/Microsoft.Management/', tostring(split(id, '/')[4]), '')\\n    | extend exempt_details = pack_all()\\n    ) on $left.policy_assignment_id == $right.exempt_policy_assignment_id\\n// Check if exempt scopes matches resource location\\n| where (isempty(exempt_management_group) or (managment_group_chain has exempt_management_group))\\n| where (isempty(exempt_subscription_id) or (subscription_id =~ exempt_subscription_id))\\n| where (isempty(exempt_resource_group) or (resource_group =~ exempt_resource_group))\\n// Add reference if all polcies are exempted\\n| extend exempt_policy_definition_ref_ids = iff(array_length(exempt_policy_definition_ref_ids) > 0, exempt_policy_definition_ref_ids, todynamic('[\\\"All\\\"]'))\\n// Check if policy definition reference id is exempted\\n| where (exempt_policy_definition_ref_ids has 'All') or (exempt_policy_definition_ref_ids has policy_definition_ref_id)\\n| project exempt_id, exempt_category, exempt_display_name, exempt_description, exempt_scope, policy_definition_ref_id, exempt_policy_definition_ref_ids, exempt_details, policy_assignment_id\\n| order by exempt_display_name, policy_definition_ref_id\",\"size\":4,\"title\":\"Exemptions\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"exempt_id\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Edit\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"EditExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"exemptionId\",\"source\":\"column\",\"value\":\"exempt_id\"},{\"name\":\"assignmentId\",\"source\":\"column\",\"value\":\"policy_assignment_id\"}]},\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"exempt_category\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"13ch\"}},{\"columnMatch\":\"exempt_display_name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"75ch\"}},{\"columnMatch\":\"exempt_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"exempt_scope\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"linkIsContextBlade\":false,\"showIcon\":true,\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"policy_definition_ref_id\",\"formatter\":5},{\"columnMatch\":\"exempt_details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"policy_assignment_id\",\"formatter\":5},{\"columnMatch\":\"exempt_management_group\",\"formatter\":5},{\"columnMatch\":\"managment_group_chain\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"exempt_id\",\"label\":\"Action\"},{\"columnId\":\"exempt_category\",\"label\":\"Category\"},{\"columnId\":\"exempt_display_name\",\"label\":\"Display Name\"},{\"columnId\":\"exempt_description\",\"label\":\"Description\"},{\"columnId\":\"exempt_scope\",\"label\":\"Scope\"},{\"columnId\":\"exempt_policy_definition_ref_ids\",\"label\":\"Exempted Policies\"},{\"columnId\":\"exempt_details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_compliance_state\",\"comparison\":\"isEqualTo\",\"value\":\"exempt\"},{\"parameterName\":\"_selected_resource_id\",\"comparison\":\"isNotEqualTo\"}],\"name\":\"query - exemptions -arg\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where id =~ '{_selected_resource_id}'\\n| union (\\n    resourcecontainers\\n    | where id =~ '{_selected_resource_id}'\\n)\\n| extend details = pack_all()\\n| project id, type, tags, action='Create Exempt' , details\",\"size\":4,\"title\":\"Resource\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"60ch\"}},{\"columnMatch\":\"type\",\"formatter\":16,\"formatOptions\":{\"showIcon\":true,\"customColumnWidthSetting\":\"40ch\"}},{\"columnMatch\":\"tags\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"action\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"bladeOpenContext\":{\"bladeName\":\"CreateExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"assignmentId\",\"source\":\"static\",\"value\":\"{_assignment}\"},{\"name\":\"exemptionScope\",\"source\":\"column\",\"value\":\"id\"},{\"name\":\"definitionReferenceIds~\",\"source\":\"static\",\"value\":\"null\"},{\"name\":\"returnJsData~\",\"source\":\"static\",\"value\":\"false\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Display Name\"},{\"columnId\":\"type\",\"label\":\"Type\"},{\"columnId\":\"tags\",\"label\":\"Tags\"},{\"columnId\":\"action\",\"label\":\"Action\"},{\"columnId\":\"details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_category\",\"comparison\":\"isEqualTo\",\"value\":\"resource\"},{\"parameterName\":\"_selected_resource_id\",\"comparison\":\"isNotEqualTo\"}],\"name\":\"query - resource_details\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.authorization/policydefinitions\\\"\\n| where id =~ '/providers/microsoft.authorization/policydefinitions/{_selected_policy_definition_id}'\\n| extend policy_definition_id = tolower(id)\\n| extend policy_definition_display_name = properties.displayName\\n| extend policy_definition_version = properties.metadata.version\\n| extend policy_definition_description = properties.description\\n| extend subscription_list = parse_csv('{_selected_subscription_list}')\\n| extend policy_definition_details = pack_all()\\n| project policy_definition_display_name, policy_definition_version, policy_definition_description, severity='{_selected_severity}', assessment_key='{_selected_assessment_key}', policy_definition_details, subscription_list\\n\",\"size\":4,\"title\":\"Policy\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"policy_definition_display_name\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"100ch\"}},{\"columnMatch\":\"policy_definition_version\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"policy_definition_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"severity\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"assessment_key\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"View\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"GenericRecommendationDetailsBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"assessmentKey\",\"source\":\"column\",\"value\":\"assessment_key\"},{\"name\":\"subscriptionIds\",\"source\":\"column\",\"value\":\"subscription_list\"},{\"name\":\"showSecurityCenterCommandBar~\",\"source\":\"static\",\"value\":\"false\"},{\"name\":\"assessmentOwners~\",\"source\":\"static\",\"value\":\"null\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"policy_definition_details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"subs\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"Property\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Value\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"170ch\"}}],\"labelSettings\":[{\"columnId\":\"policy_definition_display_name\",\"label\":\"Display Name\"},{\"columnId\":\"policy_definition_version\",\"label\":\"Version\"},{\"columnId\":\"policy_definition_description\",\"label\":\"Description\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"assessment_key\",\"label\":\"Recomendation\"},{\"columnId\":\"policy_definition_details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_policy_definition_id\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"_selected_category\",\"comparison\":\"isEqualTo\",\"value\":\"policy\"}],\"name\":\"query - policy_definition_details\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.authorization/policysetdefinitions\\\"\\n| where id =~ '{_policy_set_definition_id}'\\n| extend initiative_name = tostring(properties.displayName)\\n| extend initiative_version = tostring(properties.metadata.version)\\n| mv-expand policy_definition_group = todynamic(properties.policyDefinitionGroups) limit 2000\\n| extend policy_definition_group_name = tolower(tostring(policy_definition_group.name))\\n| extend policy_definition_group_display_name = tostring(policy_definition_group.displayName)\\n| extend policy_definition_group_description = tostring(policy_definition_group.description)\\n| where policy_definition_group_name == '{_selected_policy_definition_group_name}'\\n| extend control_info=pack(\\n \\\"Name\\\" , policy_definition_group_name, \\n \\\"Display Name\\\", policy_definition_group_display_name, \\n \\\"Description\\\", policy_definition_group_description)\\n| mv-expand control_info\\n| extend prop=bag_keys(control_info)\\n| project Property = prop[0], Value = control_info[tostring(prop[0])]\",\"size\":1,\"title\":\"Control\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Property\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Value\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"200ch\"}}]}},\"conditionalVisibility\":{\"parameterName\":\"_selected_category\",\"comparison\":\"isEqualTo\",\"value\":\"group\"},\"name\":\"query - control_info\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"group - by_control - details\"},{\"type\":1,\"content\":{\"json\":\"**Details** (select a row to view additional information)\"},\"name\":\"text - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"by_control\"},\"name\":\"group - by_control\",\"styleSettings\":{\"margin\":\"0px\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::tenant\"],\"parameters\":[{\"id\":\"0ec81cee-ea39-4fab-86ec-19fe49e437e8\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_category\",\"label\":\"Policy Category\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\" policyresources \\n | where type =~ 'Microsoft.Authorization/PolicySetDefinitions'\\n | where id =~ '{_policy_set_definition_id}'\\n | extend policy_definitions = todynamic(properties.policyDefinitions)\\n | mv-expand policy_definitions limit 2000\\n | extend policy_definition_id = tolower(tostring(policy_definitions.policyDefinitionId))\\n| join kind=leftouter (\\n    policyresources\\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_category = tostring(properties.metadata.category)\\n    | project policy_definition_id, policy_definition_category\\n) on policy_definition_id\\n| distinct policy_definition_category\\n| order by policy_definition_category asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"ace9a84e-5e18-4932-9f99-6b2e63625e1d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_definitions\",\"label\":\"Policy Definitions\",\"type\":2,\"description\":\"Only shows controls that have a policy attached with targeted resources. (list can differ per environment)\",\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources \\n | where type =~ 'Microsoft.Authorization/PolicySetDefinitions'\\n | where id =~ '{_policy_set_definition_id}'\\n | extend policy_definitions = todynamic(properties.policyDefinitions)\\n | mv-expand policy_definitions limit 2000\\n | extend policy_definition_ref_id = tostring(policy_definitions.policyDefinitionReferenceId)\\n | extend policy_definition_id = tolower(tostring(policy_definitions.policyDefinitionId))\\n| join kind=leftouter (\\n    policyresources\\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_display_name = tostring(properties.displayName)\\n    | extend policy_definition_category = tostring(properties.metadata.category)\\n    | project policy_definition_id, policy_definition_display_name, policy_definition_category\\n) on policy_definition_id\\n| where policy_definition_category in~ ({_policy_category})\\n| project  value=policy_definition_id, label=policy_definition_display_name,group=policy_definition_category\\n| order by label asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"14ba385c-1cdb-4711-90b2-7f04bcd94670\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_resource_compliance\",\"label\":\"Resource Compliance\",\"type\":2,\"description\":\"Filter resources by compliance state. By default compliant resources are filtered out.\",\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\n {\\n \\\"label\\\": \\\"compliant\\\",\\n \\\"value\\\": \\\"200\\\",\\n \\\"selected\\\": false\\n },\\n {\\n \\\"label\\\": \\\"noncompliant\\\",\\n \\\"value\\\": \\\"300\\\",\\n \\\"selected\\\": true \\n },\\n {\\n \\\"label\\\": \\\"exempt\\\",\\n \\\"value\\\": \\\"50\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"error\\\",\\n  \\\"value\\\": \\\"150\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"conflict\\\",\\n \\\"value\\\": \\\"100\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"protected\\\",\\n  \\\"value\\\": \\\"75\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"unknown\\\",\\n \\\"value\\\": \\\"10\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"notapplicable\\\",\\n \\\"value\\\": \\\"0\\\",\\n \\\"selected\\\": false \\n }\\n]\\n\\n\\n\\n\\n\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},\"name\":\"parameters - 0 - Copy\",\"styleSettings\":{\"margin\":\"0px\",\"padding\":\"0px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// resource details\\npolicyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tostring(properties.policyAssignmentId)\\n| where policy_assignment_id =~ '{_assignment}' \\n| extend subscription_id = tostring(properties.subscriptionId)\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend state_weight = toint(properties.stateWeight)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| where  tostring(state_weight) == '{_resource_compliance}' \\n| extend resource_id = tostring(properties.resourceId)\\n| extend resource_type = tostring(properties.resourceType)\\n| extend last_updated = tostring(properties.timestamp)\\n| extend policy_definition_id = tolower(properties.policyDefinitionId)\\n| where policy_definition_id in~ ({_policy_definitions})\\n| extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| summarize state_weight=arg_max(state_weight, *), subscription_list=make_set(subscription_id) by policy_definition_id, resource_id \\n| where  tostring(state_weight) == '{_resource_compliance}' \\n| extend name = resource_id\\n| extend id = strcat(policy_definition_id, resource_id)\\n| extend parent_id = strcat(policy_definition_id)\\n| extend category = 'resource'\\n| extend action = 'Create Exempt'\\n| union (\\n// policy details\\n policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend policy_assignment_id = tostring(properties.policyAssignmentId)\\n | where policy_assignment_id =~ '{_assignment}' \\n | extend subscription_id = tostring(properties.subscriptionId)\\n | where subscription_id in~ ({_subscriptions:subid})\\n  | extend state_weight = toint(properties.stateWeight)\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n | where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n | extend resource_id = tostring(properties.resourceId)\\n | extend policy_definition_id = tolower(properties.policyDefinitionId)\\n | extend policy_definition_id = tolower(properties.policyDefinitionId)\\n | where policy_definition_id in~ ({_policy_definitions})\\n | join kind=leftouter \\n (\\n    policyresources \\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_display_name=tostring(properties.displayName)\\n    | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n    | project policy_definition_id, policy_definition_display_name, policy_definition_ref_id\\n ) on policy_definition_id\\n | summarize state_weight=arg_max(state_weight, *), subscription_list=make_set(subscription_id), total_resources=countif(tostring(state_weight)  in~ ({_resource_compliance})) by policy_definition_id\\n | where total_resources > 0\\n // get assessment severity\\n| join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(properties.metadata.policyDefinitionId)\\n    | extend severity = tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize  severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n) on policy_definition_id\\n | extend name = policy_definition_display_name\\n | extend id = strcat(policy_definition_id)\\n | extend parent_id = ''\\n | extend category='policy'\\n | extend recommendation = 'View'\\n)\\n| extend compliance_state = case (\\n    state_weight == 300, 'noncompliant',\\n    state_weight == 200, 'compliant',\\n    state_weight == 150, 'error',\\n    state_weight == 100, 'conflict',\\n    state_weight == 75, 'protected',\\n    state_weight == 50, 'exempt',\\n    state_weight == 10, 'unknown',\\n    state_weight == 0,'notapplicable', \\n    'notapplicable'\\n )\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| extend severity = iff(category == 'resource', '', severity)\\n| extend subscription_id = iff(category == 'policy', '', subscription_id)\\n| extend compliance_reason = iff(category == 'policy', '', compliance_reason)\\n| project-away state_weight\\n// minimize return payload size\\n| extend policy_definition_id = split(policy_definition_id, '/')[-1]\\n| extend id = hash_md5(strcat(id))\\n| extend parent_id = hash_md5(parent_id)\\n| project id, parent_id, name, compliance_state, total_resources, compliance_reason, severity, last_updated, subscription_id, subscription_list, assessment_key, category, resource_id, policy_definition_ref_id, policy_definition_id\\n| extend severity_weight = case (\\n    severity =~ 'High', 5,\\n    severity =~ 'Medium', 4,\\n    severity =~ 'Low', 3,\\n    severity =~ 'Unknown', 2,\\n    1\\n )\\n| order by severity_weight, name asc\\n| project-away severity_weight\\n\",\"size\":0,\"title\":\"Compliance\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"compliance_state\",\"parameterName\":\"_selected_compliance_state\",\"parameterType\":1},{\"fieldName\":\"category\",\"parameterName\":\"_selected_category\",\"parameterType\":1},{\"fieldName\":\"resource_id\",\"parameterName\":\"_selected_resource_id\",\"parameterType\":1},{\"fieldName\":\"policy_definition_id\",\"parameterName\":\"_selected_policy_definition_id\",\"parameterType\":1},{\"fieldName\":\"policy_definition_ref_id\",\"parameterName\":\"_selected_policy_definition_ref_id\",\"parameterType\":1},{\"fieldName\":\"subscription_list\",\"parameterName\":\"_selected_subscription_list\",\"parameterType\":1},{\"fieldName\":\"severity\",\"parameterName\":\"_selected_severity\",\"parameterType\":1},{\"fieldName\":\"assessment_key\",\"parameterName\":\"_selected_assessment_key\",\"parameterType\":1}],\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":5},{\"columnMatch\":\"parent_id\",\"formatter\":5},{\"columnMatch\":\"name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"linkIsContextBlade\":false,\"showIcon\":true,\"customColumnWidthSetting\":\"120ch\"}},{\"columnMatch\":\"compliance_state\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"compliant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"noncompliant\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"exempt\",\"representation\":\"stopped\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"total_resources\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"10ch\"}},{\"columnMatch\":\"compliance_reason\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"18ch\"}},{\"columnMatch\":\"severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Unknown\",\"representation\":\"Sev3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Ellipsis\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"last_updated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"subscription_id\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"subscription_list\",\"formatter\":5},{\"columnMatch\":\"assessment_key\",\"formatter\":5},{\"columnMatch\":\"category\",\"formatter\":5},{\"columnMatch\":\"policy_definition_id\",\"formatter\":5},{\"columnMatch\":\"resource_type\",\"formatter\":16,\"formatOptions\":{\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"policy_set_definition_id\",\"formatter\":5},{\"columnMatch\":\"policy_definition_display_name\",\"formatter\":5},{\"columnMatch\":\"policy_assignment_id\",\"formatter\":5},{\"columnMatch\":\"resource_group\",\"formatter\":5}],\"rowLimit\":10000,\"hierarchySettings\":{\"idColumn\":\"id\",\"parentColumn\":\"parent_id\",\"treeType\":0,\"expanderColumn\":\"name\"},\"labelSettings\":[{\"columnId\":\"name\",\"label\":\"Name\"},{\"columnId\":\"compliance_state\",\"label\":\"Compliance State\"},{\"columnId\":\"total_resources\",\"label\":\"Total\"},{\"columnId\":\"compliance_reason\",\"label\":\"Reason\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"last_updated\",\"label\":\"Last Updated\"},{\"columnId\":\"subscription_id\",\"label\":\"Subscription\"}]},\"sortBy\":[]},\"name\":\"query - by_policy\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Details** (select a row to view additional information)\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.policyinsights/policystates\\\"\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend resource_id = tostring(properties.resourceId)\\n| where resource_id =~ '{_selected_resource_id}'\\n| extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n| where policy_definition_ref_id =~ '{_selected_policy_definition_ref_id}'\\n| where properties.complianceState == 'Exempt'\\n| extend subscription_id = tolower(subscriptionId)\\n| extend resource_group = resourceGroup\\n| extend policy_definition_id = tolower(tostring(properties.policySetDefinitionId))\\n// Get management group chain for resource \\n| join kind=leftouter ( \\n    resourcecontainers\\n    | where type =~ 'microsoft.resources/subscriptions'\\n    | extend subscription_id = tolower(split(id, '/')[2])\\n    | mv-expand managment_group_chain=properties.managementGroupAncestorsChain\\n    | summarize managment_group_chain=make_set(managment_group_chain.name) by subscription_id\\n) on subscription_id\\n// Get exempts for policy assignment\\n| join kind=leftouter (\\n    policyresources\\n    | where type == \\\"microsoft.authorization/policyexemptions\\\"\\n    | extend exempt_expires_on = todatetime(properties.expiresOn)\\n    // Filter out expired exempts\\n    | where isempty(exempt_expires_on) or exempt_expires_on > now()\\n    | extend exempt_id = id\\n    | extend exempt_subscription_id = subscriptionId\\n    | extend exempt_resource_group = resourceGroup\\n    | extend exempt_policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n    | extend exempt_policy_definition_ref_ids = todynamic(properties.policyDefinitionReferenceIds)\\n    | extend exempt_category = tostring(properties.exemptionCategory)\\n    | extend exempt_display_name = tostring(properties.displayName)\\n    | extend exempt_description = tostring(properties.description)\\n    | extend exempt_scope = tostring(split(id, '/providers/Microsoft.Authorization')[0])\\n    | extend exempt_management_group = iff(id has '/providers/Microsoft.Management/', tostring(split(id, '/')[4]), '')\\n    | extend exempt_details = pack_all()\\n    ) on $left.policy_assignment_id == $right.exempt_policy_assignment_id\\n// Check if exempt scopes matches resource location\\n| where (isempty(exempt_management_group) or (managment_group_chain has exempt_management_group))\\n| where (isempty(exempt_subscription_id) or (subscription_id =~ exempt_subscription_id))\\n| where (isempty(exempt_resource_group) or (resource_group =~ exempt_resource_group))\\n// Add reference if all polcies are exempted\\n| extend exempt_policy_definition_ref_ids = iff(array_length(exempt_policy_definition_ref_ids) > 0, exempt_policy_definition_ref_ids, todynamic('[\\\"All\\\"]'))\\n// Check if policy definition reference id is exempted\\n| where (exempt_policy_definition_ref_ids has 'All') or (exempt_policy_definition_ref_ids has policy_definition_ref_id)\\n| project exempt_id, exempt_category, exempt_display_name, exempt_description, exempt_scope, policy_definition_ref_id, exempt_policy_definition_ref_ids, exempt_details, policy_assignment_id\\n| order by exempt_display_name, policy_definition_ref_id\",\"size\":4,\"title\":\"Exemptions\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"exempt_id\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Edit\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"EditExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"exemptionId\",\"source\":\"column\",\"value\":\"exempt_id\"},{\"name\":\"assignmentId\",\"source\":\"column\",\"value\":\"policy_assignment_id\"}]},\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"exempt_category\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"13ch\"}},{\"columnMatch\":\"exempt_display_name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"75ch\"}},{\"columnMatch\":\"exempt_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"exempt_scope\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"linkIsContextBlade\":false,\"showIcon\":true,\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"policy_definition_ref_id\",\"formatter\":5},{\"columnMatch\":\"exempt_details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"policy_assignment_id\",\"formatter\":5},{\"columnMatch\":\"exempt_management_group\",\"formatter\":5},{\"columnMatch\":\"managment_group_chain\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"exempt_id\",\"label\":\"Action\"},{\"columnId\":\"exempt_category\",\"label\":\"Category\"},{\"columnId\":\"exempt_display_name\",\"label\":\"Display Name\"},{\"columnId\":\"exempt_description\",\"label\":\"Description\"},{\"columnId\":\"exempt_scope\",\"label\":\"Scope\"},{\"columnId\":\"exempt_policy_definition_ref_ids\",\"label\":\"Exempted Policies\"},{\"columnId\":\"exempt_details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_compliance_state\",\"comparison\":\"isEqualTo\",\"value\":\"exempt\"},{\"parameterName\":\"_selected_resource_id\",\"comparison\":\"isNotEqualTo\"}],\"name\":\"query - exemptions -arg \",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where id =~ '{_selected_resource_id}'\\n| union (\\n    resourcecontainers\\n    | where id =~ '{_selected_resource_id}'\\n)\\n| extend details = pack_all()\\n| project id, type, tags, action='Create Exempt' , details\",\"size\":4,\"title\":\"Resource\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"60ch\"}},{\"columnMatch\":\"type\",\"formatter\":16,\"formatOptions\":{\"showIcon\":true,\"customColumnWidthSetting\":\"40ch\"}},{\"columnMatch\":\"tags\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"action\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"bladeOpenContext\":{\"bladeName\":\"CreateExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"assignmentId\",\"source\":\"static\",\"value\":\"{_assignment}\"},{\"name\":\"exemptionScope\",\"source\":\"column\",\"value\":\"id\"},{\"name\":\"definitionReferenceIds~\",\"source\":\"static\",\"value\":\"null\"},{\"name\":\"returnJsData~\",\"source\":\"static\",\"value\":\"false\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Display Name\"},{\"columnId\":\"type\",\"label\":\"Type\"},{\"columnId\":\"tags\",\"label\":\"Tags\"},{\"columnId\":\"action\",\"label\":\"Action\"},{\"columnId\":\"details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_category\",\"comparison\":\"isEqualTo\",\"value\":\"resource\"},{\"parameterName\":\"_selected_resource_id\",\"comparison\":\"isNotEqualTo\"}],\"name\":\"query - resource_details\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.authorization/policydefinitions\\\"\\n| where id =~ '/providers/microsoft.authorization/policydefinitions/{_selected_policy_definition_id}'\\n| extend policy_definition_id = tolower(id)\\n| extend policy_definition_display_name = properties.displayName\\n| extend policy_definition_version = properties.metadata.version\\n| extend policy_definition_description = properties.description\\n| extend subscription_list = parse_csv('{_selected_subscription_list}')\\n| extend policy_definition_details = pack_all()\\n| project policy_definition_display_name, policy_definition_version, policy_definition_description, severity='{_selected_severity}', assessment_key='{_selected_assessment_key}', policy_definition_details, subscription_list\\n\",\"size\":4,\"title\":\"Policy\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"policy_definition_display_name\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"100ch\"}},{\"columnMatch\":\"policy_definition_version\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"policy_definition_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"severity\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"assessment_key\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"View\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"GenericRecommendationDetailsBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"assessmentKey\",\"source\":\"column\",\"value\":\"assessment_key\"},{\"name\":\"subscriptionIds\",\"source\":\"column\",\"value\":\"subscription_list\"},{\"name\":\"showSecurityCenterCommandBar~\",\"source\":\"static\",\"value\":\"false\"},{\"name\":\"assessmentOwners~\",\"source\":\"static\",\"value\":\"null\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"policy_definition_details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"subs\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"Property\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Value\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"170ch\"}}],\"labelSettings\":[{\"columnId\":\"policy_definition_display_name\",\"label\":\"Display Name\"},{\"columnId\":\"policy_definition_version\",\"label\":\"Version\"},{\"columnId\":\"policy_definition_description\",\"label\":\"Description\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"assessment_key\",\"label\":\"Recomendation\"},{\"columnId\":\"policy_definition_details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_policy_definition_id\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"_selected_category\",\"comparison\":\"isEqualTo\",\"value\":\"policy\"}],\"name\":\"query - policy_definition_details\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"group - by_policy - details\"}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"by_policy_definition\"},\"name\":\"group - by_policy_definition\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"list\",\"links\":[{\"id\":\"81c37b0c-5103-486c-bc67-55a1ed2a7034\",\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Create New\",\"style\":\"primary\",\"bladeOpenContext\":{\"bladeName\":\"CreateExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"assignmentId\",\"source\":\"static\",\"value\":\"{_assignment}\"}]}}]},\"customWidth\":\"20\",\"name\":\"links - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"value::tenant\"],\"parameters\":[{\"id\":\"c31cb974-cbef-4023-a9e7-3ec8abc63614\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_category\",\"label\":\"Policy Category\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\" policyresources \\n | where type =~ 'Microsoft.Authorization/PolicySetDefinitions'\\n | where id =~ '{_policy_set_definition_id}'\\n | extend policy_definitions = todynamic(properties.policyDefinitions)\\n | mv-expand policy_definitions limit 2000\\n | extend policy_definition_id = tolower(tostring(policy_definitions.policyDefinitionId))\\n| join kind=leftouter (\\n    policyresources\\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_category = tostring(properties.metadata.category)\\n    | project policy_definition_id, policy_definition_category\\n) on policy_definition_id\\n| distinct policy_definition_category\\n| order by policy_definition_category asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},{\"id\":\"2e46c0e0-b1e9-49a6-b4e2-9264f0550d61\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_definitions\",\"label\":\"Policy Definitions\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\" policyresources \\n | where type =~ 'Microsoft.Authorization/PolicySetDefinitions'\\n | where id =~ '{_policy_set_definition_id}'\\n | extend policy_definitions = todynamic(properties.policyDefinitions)\\n | mv-expand policy_definitions limit 2000\\n | extend policy_definition_ref_id = tostring(policy_definitions.policyDefinitionReferenceId)\\n | extend policy_definition_id = tolower(tostring(policy_definitions.policyDefinitionId))\\n| join kind=leftouter (\\n    policyresources\\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_display_name = tostring(properties.displayName)\\n    | extend policy_definition_category = tostring(properties.metadata.category)\\n    | project policy_definition_id, policy_definition_display_name, policy_definition_category\\n) on policy_definition_id\\n| where policy_definition_category in~ ({_policy_category})\\n| project  value=policy_definition_ref_id, label=policy_definition_display_name,group=policy_definition_category\\n| order by label asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"}],\"style\":\"above\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"},\"name\":\"parameters - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.authorization/policyexemptions\\\"\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where  policy_assignment_id =~ '{_assignment}'\\n| extend subscription_id = tolower(subscriptionId)\\n| extend management_group = iff(id has '/providers/Microsoft.Management/', tolower(tostring(split(id, '/')[4])), '')\\n// Get subscription list for management group\\n| join kind =leftouter   \\n ( resourcecontainers\\n    | where type == 'microsoft.resources/subscriptions'\\n    | mv-expand managementGroupParent = properties.managementGroupAncestorsChain\\n    | extend management_group = tolower(tostring(managementGroupParent.name)) //=~ 'msp.foundation'\\n    | project management_group, subscription_id_mg=tostring(split(id, '/')[2])\\n) on management_group\\n| extend subscription_id = iff(isempty(subscription_id), subscription_id_mg, subscription_id)\\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend policy_definition_ref_ids = properties.policyDefinitionReferenceIds\\n| extend policy_definition_ref_ids = iff(array_length(policy_definition_ref_ids) > 0, policy_definition_ref_ids, todynamic('[\\\"All\\\"]'))\\n| mv-expand policy_definition_ref_ids limit 2000\\n| where (policy_definition_ref_ids =~ 'All') or policy_definition_ref_ids in~ ({_policy_definitions})\\n| extend expires_on = todatetime(properties.expiresOn)\\n| extend category = tostring(properties.exemptionCategory)\\n| extend display_name = tostring(properties.displayName)\\n| extend description = tostring(properties.description)\\n| extend scope = tostring(split(id, '/providers/Microsoft.Authorization')[0])\\n| summarize policy_definition_ref_ids=makeset(policy_definition_ref_ids) by id, category, display_name, description, scope, expires_on\\n| project id, category, display_name, description, scope, expires_on, policy_definition_ref_ids\\n| order by display_name asc\\n\\n\\n\",\"size\":2,\"noDataMessage\":\"No exepmptions found for selected subscriptions\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Edit\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"EditExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"exemptionId\",\"source\":\"column\",\"value\":\"id\"},{\"name\":\"assignmentId\",\"source\":\"static\",\"value\":\"{_assignment}\"}]},\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"category\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"13ch\"}},{\"columnMatch\":\"display_name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"100ch\"}},{\"columnMatch\":\"description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"scope\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"linkIsContextBlade\":false,\"showIcon\":true,\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"expires_on\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"16ch\"}},{\"columnMatch\":\"policy_definition_ref_ids\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"60ch\"}},{\"columnMatch\":\"subscription_id\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}},{\"columnMatch\":\"exempt_scope\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true,\"customColumnWidthSetting\":\"22\"}},{\"columnMatch\":\"subscription_ids\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true}}],\"sortBy\":[{\"itemKey\":\"display_name\",\"sortOrder\":1}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Action\"},{\"columnId\":\"category\",\"label\":\"Category\"},{\"columnId\":\"display_name\",\"label\":\"Display Name\"},{\"columnId\":\"description\",\"label\":\"Description\"},{\"columnId\":\"scope\",\"label\":\"Scope\"},{\"columnId\":\"expires_on\",\"label\":\"Expires On\"},{\"columnId\":\"policy_definition_ref_ids\",\"label\":\"Exempted Policies\"}]},\"sortBy\":[{\"itemKey\":\"display_name\",\"sortOrder\":1}]},\"name\":\"query - exempts -arg\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"exempts\"},\"name\":\"group - exempts\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"3d9fe000-eca1-4618-9e76-f6474098033d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_resource_type\",\"label\":\"Resource Type\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId)) \\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n| where policy_assignment_id == '{_assignment}' // selector\\n| where subscription_id in~ ({_subscriptions:subid}) // selector\\n| extend resource_type = tolower(tostring(properties.resourceType))\\n| distinct resource_type\\n| order by resource_type asc\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"value\":[\"value::all\"]},{\"id\":\"2e11306d-16f8-42ee-9f27-80c46122c657\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_compliance\",\"label\":\"Policy Compliance\",\"type\":2,\"description\":\"Filters policies for a resource by compliance state.\",\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\n {\\n \\\"label\\\": \\\"compliant\\\",\\n \\\"value\\\": \\\"200\\\",\\n \\\"selected\\\": false\\n },\\n {\\n \\\"label\\\": \\\"noncompliant\\\",\\n \\\"value\\\": \\\"300\\\",\\n \\\"selected\\\": true \\n },\\n {\\n \\\"label\\\": \\\"exempt\\\",\\n \\\"value\\\": \\\"50\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"error\\\",\\n  \\\"value\\\": \\\"150\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"conflict\\\",\\n \\\"value\\\": \\\"100\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"protected\\\",\\n  \\\"value\\\": \\\"75\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"unknown\\\",\\n \\\"value\\\": \\\"10\\\",\\n \\\"selected\\\": false \\n },\\n {\\n \\\"label\\\": \\\"notapplicable\\\",\\n \\\"value\\\": \\\"0\\\",\\n \\\"selected\\\": false \\n }\\n]\\n\\n\\n\\n\\n\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - by_resource\",\"styleSettings\":{\"margin\":\"0px\",\"padding\":\"0px\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"// resource details\\npolicyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend subscription_id = tolower(tostring(properties.subscriptionId)) \\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n| where policy_assignment_id == '{_assignment}' \\n| where subscription_id in~ ({_subscriptions:subid})\\n| extend state_weight = toint(properties.stateWeight)\\n| extend compliance_reason = tostring(properties.complianceReasonCode)\\n| extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n| where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n| extend policy_definition_id = tolower(tostring(properties.policyDefinitionId)) \\n| extend resource_id = tolower(tostring(properties.resourceId))\\n| extend resource_type = tolower(tostring(properties.resourceType))\\n| extend resource_name = tolower(name)\\n| where resource_type in~ ({_resource_type})\\n| extend last_updated = tostring(properties.timestamp)\\n| extend policy_set_definition_id = tolower(tostring(properties.policySetDefinitionId))\\n| extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n| summarize state_weight=arg_max(state_weight, *), subscription_list=make_set(subscription_id), total_policies=countif(tostring(state_weight)  in~ ({_policy_compliance}))  by resource_id\\n| where total_policies > 0\\n | join kind=leftouter \\n (\\n    policyresources \\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_display_name=tostring(properties.displayName)\\n    | extend policy_definition_category=tostring(properties.metadata.category)\\n    | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n    | project policy_definition_id, policy_definition_display_name, policy_definition_ref_id, policy_definition_category\\n ) on policy_definition_id\\n| extend name = resource_id\\n| extend id = resource_id\\n| extend parent_id = ''\\n| extend category='resource'\\n// policy definition details\\n| union ( \\n policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n | where policy_assignment_id == '{_assignment}' \\n | extend subscription_id = tostring(properties.subscriptionId)\\n | where subscription_id in~ ({_subscriptions:subid})\\n | extend state_weight = toint(properties.stateWeight)\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n | where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n | extend policy_definition_id = tolower(tolower(properties.policyDefinitionId))\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n | extend policy_set_definition_id = tolower(tostring(properties.policySetDefinitionId))\\n | extend resource_id = tolower(tostring(properties.resourceId))\\n | extend resource_type = tolower(tostring(properties.resourceType))\\n | where resource_type in~ ({_resource_type})\\n | join kind=leftouter \\n (\\n    policyresources \\n    | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_display_name=tostring(properties.displayName)\\n    | extend policy_definition_category=tostring(properties.metadata.category)\\n    | extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n    | project policy_definition_id, policy_definition_display_name, policy_definition_ref_id, policy_definition_category\\n ) on policy_definition_id\\n | summarize state_weight=arg_max(state_weight, *), subscription_list=make_set(subscription_id) by resource_id, policy_definition_id\\n | where tostring(state_weight) =~ '{_policy_compliance}' \\n // Get assessment severity\\n | join kind=leftouter\\n    (\\n    securityresources\\n    | where type =~ \\\"microsoft.security/assessments\\\" or type =~ \\\"microsoft.security/assessments/governanceassignments\\\"\\n    | extend policy_definition_id=tolower(tostring(properties.metadata.policyDefinitionId))\\n    | extend severity=tostring(properties.metadata.severity)\\n    | extend assessment_key = name\\n    | summarize  severity=any(severity), assessment_key=any(assessment_key) by  policy_definition_id\\n    ) on policy_definition_id\\n | extend name = policy_definition_display_name\\n | extend id = strcat(policy_definition_id,resource_id)\\n | extend parent_id = resource_id\\n | extend category='policy'\\n)\\n| extend compliance_state = case (\\n    state_weight == 300, 'noncompliant',\\n    state_weight == 200, 'compliant',\\n    state_weight == 150, 'error',\\n    state_weight == 100, 'conflict',\\n    state_weight == 75, 'protected',\\n    state_weight == 50, 'exempt',\\n    state_weight == 10, 'unknown',\\n    state_weight == 0,'notapplicable', \\n    'notapplicable'\\n )\\n| extend severity = iff(isempty(severity), 'Unknown', severity)\\n| extend severity = iff(category == 'resource', '', severity)\\n| extend compliance_reason = iff(category == 'resource', '', compliance_reason)\\n| extend resource_name = tostring(split(resource_id, '/')[-1])\\n// minimize return payload size\\n| extend policy_definition_id = split(policy_definition_id, '/')[-1]\\n| extend id = hash_md5(strcat(id))\\n| extend parent_id = hash_md5(parent_id)\\n| order by resource_name asc\\n| project name, id, parent_id, compliance_state, total_policies,  compliance_reason, severity, last_updated, assessment_key, category, policy_definition_id, policy_definition_ref_id, resource_id, subscription_list, subscription_id\\n\\n\\n\\n\",\"size\":0,\"title\":\"Compliance\",\"showRefreshButton\":true,\"exportedParameters\":[{\"fieldName\":\"category\",\"parameterName\":\"_selected_category\",\"parameterType\":1},{\"fieldName\":\"compliance_state\",\"parameterName\":\"_selected_compliance_state\",\"parameterType\":1},{\"fieldName\":\"resource_id\",\"parameterName\":\"_selected_resource_id\",\"parameterType\":1},{\"fieldName\":\"policy_definition_id\",\"parameterName\":\"_selected_policy_definition_id\",\"parameterType\":1},{\"fieldName\":\"policy_definition_ref_id\",\"parameterName\":\"_selected_policy_definition_ref_id\",\"parameterType\":1},{\"fieldName\":\"subscription_list\",\"parameterName\":\"_selected_subscription_list\",\"parameterType\":1},{\"fieldName\":\"severity\",\"parameterName\":\"_selected_severity\",\"parameterType\":1},{\"fieldName\":\"assessment_key\",\"parameterName\":\"_selected_assessment_key\",\"parameterType\":1}],\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"name\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"linkIsContextBlade\":false,\"showIcon\":true,\"customColumnWidthSetting\":\"120ch\"}},{\"columnMatch\":\"id\",\"formatter\":5},{\"columnMatch\":\"parent_id\",\"formatter\":5},{\"columnMatch\":\"compliance_state\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"compliant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"noncompliant\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"exempt\",\"representation\":\"stopped\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"unknown\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"total_policies\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"18ch\"}},{\"columnMatch\":\"compliance_reason\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"18ch\"}},{\"columnMatch\":\"severity\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"High\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Medium\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Low\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Unknown\",\"representation\":\"Sev3\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Ellipsis\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"last_updated\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"assessment_key\",\"formatter\":5},{\"columnMatch\":\"category\",\"formatter\":5},{\"columnMatch\":\"policy_definition_id\",\"formatter\":5},{\"columnMatch\":\"policy_definition_ref_id\",\"formatter\":5},{\"columnMatch\":\"resource_id\",\"formatter\":5},{\"columnMatch\":\"subscription_list\",\"formatter\":5},{\"columnMatch\":\"subscription_id\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"resource_name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"}},{\"columnMatch\":\"resource_type\",\"formatter\":16,\"formatOptions\":{\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}},{\"columnMatch\":\"policy_set_definition_id\",\"formatter\":5},{\"columnMatch\":\"policy_assignment_id\",\"formatter\":5},{\"columnMatch\":\"policy_definition_display_name\",\"formatter\":5},{\"columnMatch\":\"state_weight\",\"formatter\":5},{\"columnMatch\":\"policy_definition_ids\",\"formatter\":5}],\"rowLimit\":10000,\"hierarchySettings\":{\"idColumn\":\"id\",\"parentColumn\":\"parent_id\",\"treeType\":0,\"expanderColumn\":\"name\"},\"labelSettings\":[{\"columnId\":\"name\",\"label\":\"Name\"},{\"columnId\":\"compliance_state\",\"label\":\"Compliance State\"},{\"columnId\":\"total_policies\",\"label\":\"Total\"},{\"columnId\":\"compliance_reason\",\"label\":\"Reason\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"last_updated\",\"label\":\"Last Updated\"},{\"columnId\":\"subscription_id\",\"label\":\"Subscription\"}]},\"sortBy\":[]},\"name\":\"query - by_resource\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**Details** (select a row to view additional information)\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.policyinsights/policystates\\\"\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n| where policy_assignment_id == '{_assignment}'\\n| extend resource_id = tostring(properties.resourceId)\\n| where resource_id =~ '{_selected_resource_id}'\\n| extend policy_definition_ref_id = tostring(properties.policyDefinitionReferenceId)\\n| where policy_definition_ref_id =~ '{_selected_policy_definition_ref_id}'\\n| where properties.complianceState == 'Exempt'\\n| extend subscription_id = tolower(subscriptionId)\\n| extend resource_group = resourceGroup\\n| extend policy_definition_id = tolower(tostring(properties.policySetDefinitionId))\\n// Get management group chain for resource \\n| join kind=leftouter ( \\n    resourcecontainers\\n    | where type =~ 'microsoft.resources/subscriptions'\\n    | extend subscription_id = tolower(split(id, '/')[2])\\n    | mv-expand managment_group_chain=properties.managementGroupAncestorsChain\\n    | summarize managment_group_chain=make_set(managment_group_chain.name) by subscription_id\\n) on subscription_id\\n// Get exempts for policy assignment\\n| join kind=leftouter (\\n    policyresources\\n    | where type == \\\"microsoft.authorization/policyexemptions\\\"\\n    | extend exempt_expires_on = todatetime(properties.expiresOn)\\n    // Filter out expired exempts\\n    | where isempty(exempt_expires_on) or exempt_expires_on > now()\\n    | extend exempt_id = id\\n    | extend exempt_subscription_id = subscriptionId\\n    | extend exempt_resource_group = resourceGroup\\n    | extend exempt_policy_assignment_id = tolower(tostring(properties.policyAssignmentId))\\n    | extend exempt_policy_definition_ref_ids = todynamic(properties.policyDefinitionReferenceIds)\\n    | extend exempt_category = tostring(properties.exemptionCategory)\\n    | extend exempt_display_name = tostring(properties.displayName)\\n    | extend exempt_description = tostring(properties.description)\\n    | extend exempt_scope = tostring(split(id, '/providers/Microsoft.Authorization')[0])\\n    | extend exempt_management_group = iff(id has '/providers/Microsoft.Management/', tostring(split(id, '/')[4]), '')\\n    | extend exempt_details = pack_all()\\n    ) on $left.policy_assignment_id == $right.exempt_policy_assignment_id\\n// Check if exempt scopes matches resource location\\n| where (isempty(exempt_management_group) or (managment_group_chain has exempt_management_group))\\n| where (isempty(exempt_subscription_id) or (subscription_id =~ exempt_subscription_id))\\n| where (isempty(exempt_resource_group) or (resource_group =~ exempt_resource_group))\\n// Add reference if all polcies are exempted\\n| extend exempt_policy_definition_ref_ids = iff(array_length(exempt_policy_definition_ref_ids) > 0, exempt_policy_definition_ref_ids, todynamic('[\\\"All\\\"]'))\\n// Check if policy definition reference id is exempted\\n| where (exempt_policy_definition_ref_ids has 'All') or (exempt_policy_definition_ref_ids has policy_definition_ref_id)\\n| project exempt_id, exempt_category, exempt_display_name, exempt_description, exempt_scope, policy_definition_ref_id, exempt_policy_definition_ref_ids, exempt_details, policy_assignment_id\\n| order by exempt_display_name, policy_definition_ref_id\",\"size\":1,\"title\":\"Exemptions\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"exempt_id\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Edit\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"EditExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"exemptionId\",\"source\":\"column\",\"value\":\"exempt_id\"},{\"name\":\"assignmentId\",\"source\":\"column\",\"value\":\"policy_assignment_id\"}]},\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"exempt_category\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"13ch\"}},{\"columnMatch\":\"exempt_display_name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"75ch\"}},{\"columnMatch\":\"exempt_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"exempt_scope\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"linkIsContextBlade\":false,\"showIcon\":true,\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"policy_definition_ref_id\",\"formatter\":5},{\"columnMatch\":\"exempt_details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"17ch\"}},{\"columnMatch\":\"policy_assignment_id\",\"formatter\":5},{\"columnMatch\":\"exempt_management_group\",\"formatter\":5},{\"columnMatch\":\"managment_group_chain\",\"formatter\":5}],\"labelSettings\":[{\"columnId\":\"exempt_id\",\"label\":\"Action\"},{\"columnId\":\"exempt_category\",\"label\":\"Category\"},{\"columnId\":\"exempt_display_name\",\"label\":\"Display Name\"},{\"columnId\":\"exempt_description\",\"label\":\"Description\"},{\"columnId\":\"exempt_scope\",\"label\":\"Scope\"},{\"columnId\":\"exempt_policy_definition_ref_ids\",\"label\":\"Exempted Policies\"},{\"columnId\":\"exempt_details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_compliance_state\",\"comparison\":\"isEqualTo\",\"value\":\"exempt\"},{\"parameterName\":\"_selected_resource_id\",\"comparison\":\"isNotEqualTo\"}],\"name\":\"query - exemptions -arg\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.authorization/policydefinitions\\\"\\n| where id =~ '/providers/microsoft.authorization/policydefinitions/{_selected_policy_definition_id}'\\n| extend policy_definition_id = tolower(id)\\n| extend policy_definition_display_name = properties.displayName\\n| extend policy_definition_version = properties.metadata.version\\n| extend policy_definition_description = properties.description\\n| extend subscription_list = parse_csv('{_selected_subscription_list}')\\n| extend policy_definition_details = pack_all()\\n| project policy_definition_display_name, policy_definition_version, policy_definition_description, severity='{_selected_severity}', assessment_key='{_selected_assessment_key}', policy_definition_details, subscription_list\\n\",\"size\":4,\"title\":\"Policy\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"policy_definition_display_name\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"100ch\"}},{\"columnMatch\":\"policy_definition_version\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"policy_definition_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"severity\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"assessment_key\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"View\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"GenericRecommendationDetailsBlade\",\"extensionName\":\"Microsoft_Azure_Security\",\"bladeParameters\":[{\"name\":\"assessmentKey\",\"source\":\"column\",\"value\":\"assessment_key\"},{\"name\":\"subscriptionIds\",\"source\":\"column\",\"value\":\"subscription_list\"},{\"name\":\"showSecurityCenterCommandBar~\",\"source\":\"static\",\"value\":\"false\"},{\"name\":\"assessmentOwners~\",\"source\":\"static\",\"value\":\"null\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"policy_definition_details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"subs\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"Property\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Value\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"170ch\"}}],\"labelSettings\":[{\"columnId\":\"policy_definition_display_name\",\"label\":\"Display Name\"},{\"columnId\":\"policy_definition_version\",\"label\":\"Version\"},{\"columnId\":\"policy_definition_description\",\"label\":\"Description\"},{\"columnId\":\"severity\",\"label\":\"Severity\"},{\"columnId\":\"assessment_key\",\"label\":\"Recomendation\"},{\"columnId\":\"policy_definition_details\",\"label\":\"Details\"}]}},\"conditionalVisibilities\":[{\"parameterName\":\"_selected_policy_definition_id\",\"comparison\":\"isNotEqualTo\"},{\"parameterName\":\"_selected_category\",\"comparison\":\"isEqualTo\",\"value\":\"policy\"}],\"name\":\"query - policy_definition_details\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"resources\\n| where id =~ '{_selected_resource_id}'\\n| union (\\n    resourcecontainers\\n    | where id =~ '{_selected_resource_id}'\\n)\\n| extend details = pack_all()\\n| project id, type, tags, action='Create Exempt' , details\",\"size\":4,\"title\":\"Resource\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"id\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"60ch\"}},{\"columnMatch\":\"type\",\"formatter\":16,\"formatOptions\":{\"showIcon\":true,\"customColumnWidthSetting\":\"40ch\"}},{\"columnMatch\":\"tags\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"action\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"bladeOpenContext\":{\"bladeName\":\"CreateExemptionBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"assignmentId\",\"source\":\"static\",\"value\":\"{_assignment}\"},{\"name\":\"exemptionScope\",\"source\":\"column\",\"value\":\"id\"},{\"name\":\"definitionReferenceIds~\",\"source\":\"static\",\"value\":\"null\"},{\"name\":\"returnJsData~\",\"source\":\"static\",\"value\":\"false\"}]},\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"20ch\"}}],\"labelSettings\":[{\"columnId\":\"id\",\"label\":\"Display Name\"},{\"columnId\":\"type\",\"label\":\"Type\"},{\"columnId\":\"tags\",\"label\":\"Tags\"},{\"columnId\":\"action\",\"label\":\"Action\"},{\"columnId\":\"details\",\"label\":\"Details\"}]}},\"conditionalVisibility\":{\"parameterName\":\"_selected_resource_id\",\"comparison\":\"isNotEqualTo\"},\"name\":\"query - resource_details\",\"styleSettings\":{\"showBorder\":true}}]},\"name\":\"group - by_resource - details\"}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"by_resource\"},\"name\":\"group - by_resource\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" policyresources\\n| where type == \\\"microsoft.authorization/policysetdefinitions\\\"\\n| where id =~ '{_policy_set_definition_id}'\\n| extend policy_set_definition_id = tolower(id)\\n| extend initiative_name = tostring(properties.displayName)\\n| extend initiative_version = tostring(properties.metadata.version)\\n| extend Details=pack_all()\\n| project ['Display Name'] = tostring(properties.displayName), \\n ['Description'] = tostring(properties.description), \\n Version = tostring(properties.metadata.version),\\n ['Created On'] = format_datetime(todatetime(systemData.createdAt), 'yyyy-MM-dd HH:mm:ss'),\\n ['Created By'] = tostring(systemData.createdBy),\\n Details\\n\",\"size\":4,\"title\":\"Initiative Definition\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Action\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"bladeOpenContext\":{\"bladeName\":\"InitiativeDetail.ReactView\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"id\",\"source\":\"column\",\"value\":\"Policy Set Definition  Id\"}]}}},{\"columnMatch\":\"Display Name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"Description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Description\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Version\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Created On\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Created By\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"}},{\"columnMatch\":\"Details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Details\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Assignment Id\",\"formatter\":5}]}},\"name\":\"query - assignment_set_definition\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type == \\\"microsoft.authorization/policyassignments\\\"\\n| where id =~ '{_assignment}' // selector\\n| extend policy_set_definition_id = tolower(tostring(properties.policyDefinitionId))\\n| extend Details = pack_all()\\n| project ['Action']='Edit', ['Display Name'] = tostring(properties.displayName),\\n ['Created By'] = tostring(systemData.createdBy),\\n ['Created On'] = format_datetime(todatetime(systemData.createdAt), 'yyyy-MM-dd HH:mm:ss'),\\n ['Last Modified By'] = tostring(systemData.lastModifiedBy),\\n ['Last Modified On'] = format_datetime(todatetime(systemData.lastModifiedAt), 'yyyy-MM-dd HH:mm:ss'),\\n Details, id\\n\\n\",\"size\":4,\"title\":\"Initiative Assignment\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Action\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"EditAssignmentBladeV2\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"assignmentId\",\"source\":\"column\",\"value\":\"id\"}]}}},{\"columnMatch\":\"Display Name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"Created By\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"40ch\"}},{\"columnMatch\":\"Created On\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"25ch\"},\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},{\"columnMatch\":\"Details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Details\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"id\",\"formatter\":5},{\"columnMatch\":\"Description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Description\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"Version\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"15ch\"}}]}},\"name\":\"query - assignment_set_assignment\",\"styleSettings\":{\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources \\n| where type =~ 'microsoft.authorization/policysetdefinitions'\\n| where id =~ '{_policy_set_definition_id}'\\n| extend policy_set_definition_id = tolower(id)\\n| extend default_parameters = properties.parameters\\n| mv-expand default_parameters limit 2000\\n| extend prop=bag_keys(todynamic(default_parameters))[0]\\n| project param_name=tostring(prop),param_display_name=default_parameters[tostring(prop)].metadata.displayName, param_default_value=default_parameters[tostring(prop)].defaultValue, param_allowed_values=default_parameters[tostring(prop)].allowedValues, policy_set_definition_id\\n| join kind=leftouter( \\n policyresources \\n | where type == \\\"microsoft.authorization/policyassignments\\\"\\n | where id=~ '{_assignment}'\\n | extend assignment_parameters = properties.parameters\\n | extend policy_set_definition_id = tolower(tostring(properties.policyDefinitionId))\\n | mv-expand assignment_parameters\\n | extend prop=bag_keys(todynamic(assignment_parameters))[0]\\n | project param_name = tostring(prop), param_assignment_value = assignment_parameters[tostring(prop)].value, policy_set_definition_id\\n ) on param_name, policy_set_definition_id\\n| order by tostring(param_display_name) asc\\n| project Action = 'Edit', param_name, ['Display Name']=param_display_name, ['Allowed Values']=param_allowed_values, ['Default Values']=param_default_value, ['Assignment Values']=param_assignment_value, assigment_id='{_assignment}'\\n| extend Details = pack_all()\",\"size\":2,\"title\":\"Parameters\",\"showExportToExcel\":true,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Action\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"linkLabel\":\"Edit\",\"linkIsContextBlade\":false,\"bladeOpenContext\":{\"bladeName\":\"EditAssignmentBladeV2\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"assignmentId\",\"source\":\"column\",\"value\":\"assigment_id\"}]}}},{\"columnMatch\":\"param_name\",\"formatter\":5},{\"columnMatch\":\"Display Name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"75ch\"}},{\"columnMatch\":\"Allowed Values\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"Default Values\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"Assignment Values\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"assigment_id\",\"formatter\":5},{\"columnMatch\":\"Details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"View\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"Asignment Values\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"30ch\"}},{\"columnMatch\":\"details\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"12ch\"}},{\"columnMatch\":\"param_display_name\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"70ch\"}}],\"rowLimit\":10000,\"filter\":true}},\"name\":\"query - assignment_paramaters\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"assignment\"},\"name\":\"group - assignment\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"316087ec-4bfc-4e44-a315-a4a44ceaca73\",\"cellValue\":\"_selected_export_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Controls\",\"subTarget\":\"controls\",\"style\":\"link\"},{\"id\":\"ffc4ae0c-88d2-46c9-b782-f87013629a80\",\"cellValue\":\"_selected_export_tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Policies\",\"subTarget\":\"policies\",\"style\":\"link\"}]},\"name\":\"links - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\npolicyresources\\n| where type == \\\"microsoft.authorization/policysetdefinitions\\\"\\n| extend policy_set_definition_id = tolower(id)\\n| where policy_set_definition_id == '{_policy_set_definition_id}'\\n| extend policy_set_definition_groups = properties.policyDefinitionGroups\\n| mv-expand policy_set_definition_groups limit 2000\\n| project policy_definition_group_name = tolower(policy_set_definition_groups.name), policy_definition_group_display_name=policy_set_definition_groups.displayName, policy_definition_group_description=policy_set_definition_groups.description, policy_set_definition_id\\n| order by policy_definition_group_name asc\\n| join kind=leftouter(\\n policyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend subscription_id = tolower(tostring(properties.subscriptionId)) \\n | extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n | where policy_assignment_id == '{_assignment}' // selector\\n | where subscription_id in~ ({_subscriptions:subid}) // selector\\n | extend resource_id = tolower(tostring(properties.resourceId))\\n | extend state_weight = toint(properties.stateWeight)\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n | where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n | extend policy_definition_id = tolower(tolower(properties.policyDefinitionId))\\n | extend policy_set_definition_id = tolower(tolower(properties.policySetDefinitionId))\\n | extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n | mv-expand policy_definition_group_names limit 2000\\n | extend policy_definition_group_name = tolower(tostring(policy_definition_group_names))\\n | summarize state_weight=max(state_weight) by policy_definition_group_name, policy_set_definition_id, policy_assignment_id, policy_definition_id, resource_id\\n | summarize resource_count=count() by policy_definition_group_name, policy_set_definition_id, policy_assignment_id, state_weight\\n | extend noncompliant_resources = toint(iff(state_weight == 300, resource_count, 0))\\n | extend compliant_resources = toint(iff(state_weight == 200, resource_count, 0))\\n | extend exempt_resources = toint(iff(state_weight == 50, resource_count, 0))\\n | extend other_resources = toint(iff(state_weight in (10, 75, 100, 150), resource_count, 0))\\n | summarize state_weight=max(state_weight), \\n noncompliant_resources=sum(noncompliant_resources),\\n compliant_resources=sum(compliant_resources),\\n exempt_resources=sum(exempt_resources),\\n other_resources=sum(other_resources)\\n by policy_definition_group_name, \\n policy_set_definition_id, \\n policy_assignment_id\\n | extend compliance_state = case (\\n state_weight == 300, 'noncompliant',\\n state_weight == 200, 'compliant',\\n state_weight == 150, 'error',\\n state_weight == 100, 'conflict',\\n state_weight == 75, 'protected',\\n state_weight == 50, 'exempt',\\n state_weight == 10, 'unknown',\\n state_weight == 0,'notapplicable', \\n 'notapplicable'\\n )\\n) on policy_definition_group_name\\n| extend compliance_state=iff(isempty(compliance_state), 'notapplicable', compliance_state)\\n| extend export_date = now()\\n| project export_date, \\n ['Name'] = policy_definition_group_name, \\n ['Display Name'] = policy_definition_group_display_name, \\n ['Description'] = policy_definition_group_description, \\n ['State'] = compliance_state, \\n ['Total Resources'] = (compliant_resources + noncompliant_resources + exempt_resources + other_resources),\\n ['Compliant' ] = compliant_resources, \\n ['NonCompliant'] = noncompliant_resources, \\n ['Exempt'] = exempt_resources, \\n ['Other'] = other_resources\\n| order by tostring(Name) asc\\n\",\"size\":2,\"showRefreshButton\":true,\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"export_date\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"Display Name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"55ch\"}},{\"columnMatch\":\"Description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Description\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"State\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"compliant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"noncompliant\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"exempt\",\"representation\":\"stopped\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"more\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"16ch\"}},{\"columnMatch\":\"policy_definition_group_display_name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"policy_definition_group_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}}],\"rowLimit\":10000,\"filter\":true}},\"name\":\"query - export - controls\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_export_tab\",\"comparison\":\"isEqualTo\",\"value\":\"controls\"},\"name\":\"group - export - controls\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\npolicyresources\\n| where type == \\\"microsoft.authorization/policysetdefinitions\\\"\\n| extend policy_set_definition_id = tolower(id)\\n| where policy_set_definition_id == '{_policy_set_definition_id}'\\n| extend policy_set_definition_groups = properties.policyDefinitionGroups\\n//| extend policy_set_definition_id, policy_definition_name = name\\n| mv-expand properties.policyDefinitions limit 2000\\n| extend policy_definition_id = tolower(properties_policyDefinitions.policyDefinitionId)\\n| join kind=leftouter(\\n    policyresources\\n    | where type == \\\"microsoft.authorization/policydefinitions\\\"\\n    | extend policy_definition_id = tolower(id)\\n    | extend policy_definition_name = name\\n    | extend policy_definition_display_name = tostring(properties.displayName)\\n    | extend policy_definition_descrioption = tostring(properties.description)\\n    | project policy_definition_id, policy_definition_name, policy_definition_display_name, policy_definition_descrioption\\n) on policy_definition_id\\n| join kind=leftouter(\\npolicyresources \\n | where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n | extend subscription_id = tolower(tostring(properties.subscriptionId)) \\n | extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n | where policy_assignment_id == '{_assignment}' // selector\\n | where subscription_id in~ ({_subscriptions:subid}) // selector\\n | extend resource_id = tolower(tostring(properties.resourceId))\\n | extend state_weight = toint(properties.stateWeight)\\n | extend compliance_reason = tostring(properties.complianceReasonCode)\\n | extend exclude_noncompliant_reasons_list = dynamic([{_exclude_reasons}])\\n | where array_length(exclude_noncompliant_reasons_list) == 0 or (compliance_reason !in~ (exclude_noncompliant_reasons_list) and state_weight == 300) or state_weight != 300\\n | extend policy_definition_id = tolower(tolower(properties.policyDefinitionId))\\n | extend policy_set_definition_id = tolower(tolower(properties.policySetDefinitionId))\\n //| extend policy_definition_group_names = iff(isnotnull(properties.policyDefinitionGroupNames), properties.policyDefinitionGroupNames, dynamic(['']))\\n //| mv-expand policy_definition_group_names limit 2000\\n //| extend policy_definition_group_name = tolower(tostring(policy_definition_group_names))\\n | summarize state_weight=max(state_weight) by policy_set_definition_id, policy_assignment_id, policy_definition_id, resource_id\\n | summarize resource_count=count() by policy_set_definition_id, policy_assignment_id, policy_definition_id, state_weight\\n | extend noncompliant_resources = toint(iff(state_weight == 300, resource_count, 0))\\n | extend compliant_resources = toint(iff(state_weight == 200, resource_count, 0))\\n | extend exempt_resources = toint(iff(state_weight == 50, resource_count, 0))\\n | extend other_resources = toint(iff(state_weight in (10, 75, 100, 150), resource_count, 0))\\n | summarize state_weight=max(state_weight), \\n noncompliant_resources=sum(noncompliant_resources),\\n compliant_resources=sum(compliant_resources),\\n exempt_resources=sum(exempt_resources),\\n other_resources=sum(other_resources)\\n by  policy_assignment_id, policy_set_definition_id, policy_definition_id\\n  | extend compliance_state = case (\\n state_weight == 300, 'noncompliant',\\n state_weight == 200, 'compliant',\\n state_weight == 150, 'error',\\n state_weight == 100, 'conflict',\\n state_weight == 75, 'protected',\\n state_weight == 50, 'exempt',\\n state_weight == 10, 'unknown',\\n state_weight == 0,'notapplicable', \\n 'notapplicable'\\n )\\n) on policy_definition_id\\n| extend compliance_state=iff(isempty(compliance_state), 'notapplicable', compliance_state)\\n| extend export_date = now()\\n| project export_date, \\n ['Name'] = policy_definition_name, \\n ['Display Name'] = policy_definition_display_name, \\n ['Description'] = policy_definition_descrioption, \\n ['State'] = compliance_state, \\n ['Total Resources'] = (compliant_resources + noncompliant_resources + exempt_resources + other_resources),\\n ['Compliant' ] = compliant_resources, \\n ['NonCompliant'] = noncompliant_resources, \\n ['Exempt'] = exempt_resources,\\n ['Other'] = other_resources \\n| order by  ['Display Name'] asc\\n\",\"size\":2,\"showRefreshButton\":true,\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"export_date\",\"formatter\":5},{\"columnMatch\":\"Name\",\"formatter\":5,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"35ch\"}},{\"columnMatch\":\"Display Name\",\"formatter\":1,\"formatOptions\":{\"customColumnWidthSetting\":\"120ch\"}},{\"columnMatch\":\"Description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Description\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"15ch\"}},{\"columnMatch\":\"State\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"compliant\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"noncompliant\",\"representation\":\"4\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"exempt\",\"representation\":\"stopped\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"more\",\"text\":\"{0}{1}\"}],\"customColumnWidthSetting\":\"16ch\"}},{\"columnMatch\":\"policy_definition_group_display_name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}},{\"columnMatch\":\"policy_definition_group_description\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}}],\"rowLimit\":10000,\"filter\":true}},\"name\":\"query - export - policies\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_export_tab\",\"comparison\":\"isEqualTo\",\"value\":\"policies\"},\"name\":\"group - export - policies\"}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"export\"},\"name\":\"group - export\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{_workspace}\"],\"parameters\":[{\"id\":\"5aa0730f-1995-4042-af6f-b53dc492455f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_workspace\",\"label\":\"Workspace\",\"type\":2,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resources\\n| where type =~ 'microsoft.operationalinsights/workspaces'\\n| extend subscription_id = tolower(strcat('/subscriptions/', subscriptionId))\\n| join kind=leftouter(\\n    resourcecontainers\\n    | where type == 'microsoft.resources/subscriptions'\\n    | extend subscription_id = tolower(id)\\n    | project subscription_id, subscription_name=name\\n) on subscription_id\\n| order by tolower(subscription_name) asc, tolower(name) asc\\n| project value=id, label=name, selected=false, group=subscription_name\\n\\n\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"value\":[\"\"]},{\"id\":\"\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_time_range\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":86400000}},{\"id\":\"e36c18b8-ea95-479a-837a-929eafbe3672\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_insights_table_check\",\"type\":1,\"query\":\"search *\\n| distinct Type\\n| extend policy_insights_table_exists = iff(Type contains 'PolicyInsights_CL', true, false)\\n| summarize policy_insights_table_exists=max(policy_insights_table_exists)\\n| extend message= iff(policy_insights_table_exists, 'Found PolicyInsights_CL table in at least one of the selected workspaces', 'Did not find PolicyInsights_CL table in any of the selected workspaces')\\n| project message\\n\",\"crossComponentResources\":[\"{_workspace}\"],\"isHiddenWhenLocked\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"403c1d34-3dcb-4d2a-b86d-c2e44ac06c68\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_exclude_resource_groups\",\"label\":\"Exclude Resource Groups\",\"type\":2,\"description\":\"Resources in selected resource groups will be exckluded from the query results\",\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"resourcecontainers\\n| where type == 'microsoft.resources/subscriptions/resourcegroups'\\n| extend subscription_id = tolower(strcat('/subscriptions/', subscriptionId))\\n| where subscription_id in ({_subscriptions})\\n| join kind=leftouter(\\n    resourcecontainers\\n    | where type == 'microsoft.resources/subscriptions'\\n    | extend subscription_id = tolower(id)\\n    | project subscription_id, subscription_name=name\\n) on subscription_id\\n| order by subscription_name, name asc\\n| project value=id, label=name, selected=false, group=subscription_name\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"value\":[]}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.resources/tenants\"},\"name\":\"parameters - 0\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Readme\",\"expandable\":true,\"items\":[{\"type\":1,\"content\":{\"json\":\"Policy state history relies on the collection of policy state state events created by the [Azure Event Grid](https://learn.microsoft.com/en-us/azure/event-grid/event-schema-policy?tabs=event-grid-event-schema) into a Log Analytics Workspace. An example on how to setup such a configuration can be found [here](https://github.com/Eurofiber-CloudInfra/azure-policy-insights). <br>\\n\\nBy default the workbook will query the **PolicyInisghts_CL** table on all the selected workspaces from the **Workspace** parameter. To improve query performance select only the workspace that contains the **PolicyInisghts_CL** table. To prevent this action the next time save the workbook after you made the workspace selection.\\n\\nPolicyInisghts_CL table check returned: **{_policy_insights_table_check}**\"},\"name\":\"text - 0\"}]},\"name\":\"group - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let resource_group_filter = dynamic([{_exclude_resource_groups}]);\\nPolicyInsights_CL\\n| where data_policyAssignmentId_s =~ '{_assignment}'\\n| where data_subscriptionId_g in~ ({_subscriptions:subid})\\n| where eventType_s =~ 'Microsoft.PolicyInsights.PolicyStateCreated' or eventType_s =~ 'Microsoft.PolicyInsights.PolicyStateChanged'\\n| extend resource_group_name = substring(subject_s, 0, indexof(subject_s, '/', 1, -1, 4))\\n| where array_length(resource_group_filter) == 0 or resource_group_name !in~ (resource_group_filter)\\n| summarize arg_max(eventTime_t, data_complianceState_s) by subject_s, data_policyDefinitionId_s\\n| order by eventTime_t\\n| summarize count() by data_complianceState_s\\n\",\"size\":4,\"title\":\"Latest Policy State Changes\",\"noDataMessage\":\"No state events found within your selections\",\"timeContextFromParameter\":\"_time_range\",\"exportFieldName\":\"label\",\"exportParameterName\":\"_compliance_state\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{_workspace}\"],\"visualization\":\"piechart\",\"sortBy\":[],\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Compliant\",\"color\":\"green\"},{\"seriesName\":\"NonCompliant\",\"color\":\"redBright\"},{\"seriesName\":\"Exempt\",\"color\":\"gray\"},{\"color\":\"blue\"}]}},\"customWidth\":\"33\",\"showPin\":false,\"name\":\"query - created\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let resource_group_filter = dynamic([{_exclude_resource_groups}]);\\nPolicyInsights_CL\\n| where data_policyAssignmentId_s =~ '{_assignment}'\\n| where data_subscriptionId_g in~ ({_subscriptions:subid})\\n| where eventType_s =~ 'Microsoft.PolicyInsights.PolicyStateCreated' or eventType_s =~ 'Microsoft.PolicyInsights.PolicyStateChanged'\\n| extend resource_group_name = substring(subject_s, 0, indexof(subject_s, '/', 1, -1, 4))\\n| where array_length(resource_group_filter) == 0 or resource_group_name !in~ (resource_group_filter)\\n| summarize arg_max(eventTime_t, data_complianceState_s) by subject_s, data_policyDefinitionId_s, data_subscriptionId_g\\n| where data_complianceState_s =~ 'NonCompliant'\\n| summarize noncompliant_policies=count() by subject_s, data_subscriptionId_g\\n| top 3 by noncompliant_policies\\n| project resource = subject_s, subscription=data_subscriptionId_g, noncompliant_policies\\n\",\"size\":4,\"title\":\"Top 3 Resources With NonCompliant Policy Changes\",\"noDataMessage\":\"Yah! No state changes resulted in NonCompliant policies.\",\"noDataMessageStyle\":3,\"timeContextFromParameter\":\"_time_range\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{_workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"resource\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"75ch\"}},{\"columnMatch\":\"subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":null,\"showIcon\":true,\"customColumnWidthSetting\":\"25ch\"}}],\"sortBy\":[{\"itemKey\":\"noncompliant_policies\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"noncompliant_policies\",\"sortOrder\":2}]},\"customWidth\":\"67\",\"name\":\"query - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{_workspace}\"],\"parameters\":[{\"id\":\"1e55863a-9c17-4f00-9598-82aac28fb4ac\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_compliance_state\",\"label\":\"Compliance State\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"Compliant\\\\\\\",\\\\n  \\\\\\\"label\\\\\\\":  \\\\\\\"Compliant\\\\\\\"\\\\n },\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"NonCompliant\\\\\\\",\\\\n  \\\\\\\"label\\\\\\\":  \\\\\\\"NonCompliant\\\\\\\"\\\\n },\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"Exempt\\\\\\\",\\\\n  \\\\\\\"label\\\\\\\":  \\\\\\\"Exempt\\\\\\\"\\\\n },\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"Error\\\\\\\",\\\\n  \\\\\\\"label\\\\\\\":  \\\\\\\"Error\\\\\\\"\\\\n },\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"Conflict\\\\\\\",\\\\n  \\\\\\\"label\\\\\\\":  \\\\\\\"Conflict\\\\\\\"\\\\n },\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"Protected\\\\\\\",\\\\n \\\\\\\"label\\\\\\\":  \\\\\\\"Protected\\\\\\\"\\\\n },\\\\n {\\\\n \\\\\\\"value\\\\\\\": \\\\\\\"Unknown\\\\\\\",\\\\n  \\\\\\\"label\\\\\\\":  \\\\\\\"Unknown\\\\\\\"\\\\n }\\\\n]\\\",\\\"transformers\\\":null}\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":8,\"value\":[\"NonCompliant\",\"Compliant\"]},{\"id\":\"0c4c138a-d69f-4104-8a89-65b9955944d7\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_event_type\",\"label\":\"Event Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"{\\\"version\\\":\\\"1.0.0\\\",\\\"content\\\":\\\"[\\\\n {\\\\n \\\\t\\\\\\\"value\\\\\\\": \\\\\\\"PolicyStateCreated\\\\\\\",\\\\n\\\\t\\\\\\\"label\\\\\\\": \\\\\\\"PolicyStateCreated\\\\\\\",\\\\n\\\\t\\\\\\\"selected\\\\\\\": true\\\\n },\\\\n {\\\\n \\\\t\\\\\\\"value\\\\\\\": \\\\\\\"PolicyStateChanged\\\\\\\",\\\\n\\\\t \\\\\\\"label\\\\\\\": \\\\\\\"PolicyStateChanged\\\\\\\",\\\\n\\\\t \\\\\\\"selected\\\\\\\": true\\\\n },\\\\n {\\\\n \\\\t\\\\\\\"value\\\\\\\": \\\\\\\"PolicyStateDeleted\\\\\\\",\\\\n\\\\t \\\\\\\"label\\\\\\\": \\\\\\\"PolicyStateDeleted\\\\\\\",\\\\n\\\\t \\\\\\\"selected\\\\\\\": false\\\\n }\\\\n]\\\",\\\"transformers\\\":null}\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"queryType\":8,\"value\":[\"PolicyStateCreated\",\"PolicyStateChanged\"]},{\"id\":\"14f7555b-7840-4fe1-96d8-a877666b078a\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_resource\",\"label\":\"Resource\",\"type\":5,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"let resource_group_filter = dynamic([{_exclude_resource_groups}]);\\nPolicyInsights_CL\\n| where data_policyAssignmentId_s =~ '{_assignment}'\\n| where data_subscriptionId_g in~ ({_subscriptions:subid})\\n| extend resource_group_name = substring(subject_s, 0, indexof(subject_s, '/', 1, -1, 4))\\n| where array_length(resource_group_filter) == 0 or resource_group_name !in~ (resource_group_filter)\\n| extend resource_name = tostring(split(subject_s, '/')[-1])\\n| distinct subject_s, resource_name\\n| order by resource_name asc\\n| project subject_s\",\"crossComponentResources\":[\"{_workspace}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"[]\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"_time_range\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":null},{\"id\":\"2583cda3-4f9e-4a12-a061-f1f3b4c81fb5\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"_policy_definitions\",\"label\":\"Policy Definitions\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"policyresources \\n| where type =~ 'Microsoft.PolicyInsights/PolicyStates'\\n| extend policy_assignment_id = tolower(tostring(properties.policyAssignmentId)) \\n| where policy_assignment_id == '{_assignment}' // selector\\n| extend policy_definition_id = tolower(tolower(properties.policyDefinitionId))\\n| distinct policy_definition_id\\n | join kind = leftouter \\n (\\n policyresources \\n | where type =~ 'Microsoft.Authorization/PolicyDefinitions'\\n | extend policy_definition_id = tolower(id)\\n | extend policy_definition_display_name = tostring(properties.displayName)\\n | extend policy_definition_category = tostring(properties.metadata.category)\\n | summarize by policy_definition_id, policy_definition_display_name, policy_definition_category\\n ) on policy_definition_id\\n| project policy_definition_id, policy_definition_display_name\\n| order by policy_definition_display_name asc\\n\",\"crossComponentResources\":[\"value::tenant\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let resource_group_filter = dynamic([{_exclude_resource_groups}]);\\nlet resource_filter = dynamic([{_resource}]);\\nPolicyInsights_CL\\n| where data_policyAssignmentId_s =~ '{_assignment}'\\n| where data_subscriptionId_g in~ ({_subscriptions:subid})\\n| where data_complianceState_s in~ ({_compliance_state})\\n| where data_policyDefinitionId_s in~ ({_policy_definitions})\\n| where array_length(resource_filter) == 0 or subject_s in~ (resource_filter)\\n| extend details = pack_all()\\n| extend event_type = case(\\n    eventType_s contains'PolicyStateCreated', 'PolicyStateCreated',\\n    eventType_s contains'PolicyStateChanged', 'PolicyStateChanged',\\n    eventType_s contains'PolicyStateDeleted', 'PolicyStateDeleted',\\n    'Uknown Type'\\n)\\n| where event_type in~ ({_event_type})\\n| extend resource_group_name = substring(subject_s, 0, indexof(subject_s, '/', 1, -1, 4))\\n| where array_length(resource_group_filter) == 0 or resource_group_name !in~ (resource_group_filter)\\n| extend alert_query = strcat('PolicyInsights_CL\\\\n', '| where data_policyDefinitionId_s == \\\"', data_policyDefinitionId_s , '\\\" and subject_s == \\\"', subject_s, '\\\" and data_complianceState_s == \\\"', data_complianceState_s, '\\\"')\\n| project\\n    event_time=format_datetime(eventTime_t,'yyyy-MM-dd [HH:mm:ss]'),\\n    resource=subject_s,\\n    subscription=topic_s,\\n    policy_definition_id=data_policyDefinitionId_s,\\n    policy_definition_ref_id=data_policyDefinitionReferenceId_s,\\n    event_type,\\n    compliandce_state=data_complianceState_s,\\n    compliance_reason=data_complianceReasonCode_s, alert_query, details\\n| order by event_time, resource\\n\",\"size\":2,\"timeContextFromParameter\":\"_time_range\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{_workspace}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"event_time\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"24ch\"}},{\"columnMatch\":\"resource\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"45ch\"}},{\"columnMatch\":\"subscription\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"alert_query\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkIsContextBlade\":true}}],\"rowLimit\":10000},\"sortBy\":[]},\"conditionalVisibility\":{\"parameterName\":\"dummy\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - policyinsights\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"policyresources\\n| where type == \\\"microsoft.authorization/policydefinitions\\\"\\n| extend detail = pack_all()\\n| project policy_definition_id=tolower(id), policy_definition_display_name = properties.displayName\",\"size\":0,\"queryType\":1,\"resourceType\":\"microsoft.resources/tenants\",\"crossComponentResources\":[\"value::tenant\"],\"gridSettings\":{\"rowLimit\":10000}},\"conditionalVisibility\":{\"parameterName\":\"dummy\",\"comparison\":\"isEqualTo\",\"value\":\"hide\"},\"name\":\"query - policy. definitions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"{\\\"version\\\":\\\"Merge/1.0\\\",\\\"merges\\\":[{\\\"id\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\",\\\"mergeType\\\":\\\"leftouter\\\",\\\"leftTable\\\":\\\"query - policyinsights\\\",\\\"rightTable\\\":\\\"query - policy. definitions\\\",\\\"leftColumn\\\":\\\"policy_definition_id\\\",\\\"rightColumn\\\":\\\"policy_definition_id\\\"}],\\\"projectRename\\\":[{\\\"originalName\\\":\\\"[query - policyinsights].event_time\\\",\\\"mergedName\\\":\\\"event_time\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].resource\\\",\\\"mergedName\\\":\\\"resource\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].subscription\\\",\\\"mergedName\\\":\\\"subscription\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policy. definitions].policy_definition_display_name\\\",\\\"mergedName\\\":\\\"policy_definition_display_name\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].policy_definition_id\\\",\\\"mergedName\\\":\\\"policy_definition_id\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].policy_definition_ref_id\\\",\\\"mergedName\\\":\\\"policy_definition_ref_id\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].event_type\\\",\\\"mergedName\\\":\\\"event_type\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].compliandce_state\\\",\\\"mergedName\\\":\\\"compliandce_state\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].compliance_reason\\\",\\\"mergedName\\\":\\\"compliance_reason\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].alert_query\\\",\\\"mergedName\\\":\\\"alert_query\\\",\\\"fromId\\\":\\\"unknown\\\"},{\\\"originalName\\\":\\\"[query - policyinsights].details\\\",\\\"mergedName\\\":\\\"details\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"},{\\\"originalName\\\":\\\"[query - policy. definitions].policy_definition_id\\\",\\\"mergedName\\\":\\\"policy_definition_id1\\\",\\\"fromId\\\":\\\"f46e987b-3477-47bc-a78b-24abb3968113\\\"}]}\",\"size\":2,\"noDataMessage\":\"No state events found within your selections\",\"queryType\":7,\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"event_time\",\"formatter\":6,\"formatOptions\":{\"customColumnWidthSetting\":\"22ch\"},\"dateFormat\":{\"showUtcTime\":true,\"formatName\":\"shortDateTimePattern\"}},{\"columnMatch\":\"resource\",\"formatter\":13,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"45ch\"}},{\"columnMatch\":\"subscription\",\"formatter\":15,\"formatOptions\":{\"linkTarget\":\"Resource\",\"showIcon\":true,\"customColumnWidthSetting\":\"22ch\"}},{\"columnMatch\":\"policy_definition_display_name\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"OpenBlade\",\"bladeOpenContext\":{\"bladeName\":\"PolicyDetailBlade\",\"extensionName\":\"Microsoft_Azure_Policy\",\"bladeParameters\":[{\"name\":\"definitionId\",\"source\":\"column\",\"value\":\"policy_definition_id\"}]},\"customColumnWidthSetting\":\"65ch\"}},{\"columnMatch\":\"policy_definition_id\",\"formatter\":5},{\"columnMatch\":\"policy_definition_ref_id\",\"formatter\":5},{\"columnMatch\":\"event_type\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"compliandce_state\",\"formatter\":0,\"formatOptions\":{\"customColumnWidthSetting\":\"20ch\"}},{\"columnMatch\":\"alert_query\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Alert Query\",\"linkIsContextBlade\":true,\"customColumnWidthSetting\":\"16ch\"}},{\"columnMatch\":\"details\",\"formatter\":7,\"formatOptions\":{\"linkTarget\":\"CellDetails\",\"linkLabel\":\"Details\",\"linkIsContextBlade\":true}}],\"rowLimit\":10000,\"filter\":true,\"labelSettings\":[{\"columnId\":\"event_time\",\"label\":\"Event Time\"},{\"columnId\":\"resource\",\"label\":\"Resource\"},{\"columnId\":\"subscription\",\"label\":\"Subscrip[tion\"},{\"columnId\":\"policy_definition_display_name\",\"label\":\"Policy Name\"},{\"columnId\":\"event_type\",\"label\":\"Event Type\"},{\"columnId\":\"compliandce_state\",\"label\":\"Compliance State\"},{\"columnId\":\"compliance_reason\",\"label\":\"Compliance Reason\"},{\"columnId\":\"alert_query\",\"label\":\"Alert Query\"},{\"columnId\":\"details\",\"label\":\"Details\"}]}},\"showPin\":false,\"name\":\"query - policyinsights_merge\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"_selected_tab\",\"comparison\":\"isEqualTo\",\"value\":\"state_changes\"},\"name\":\"group - state changes\"},{\"type\":1,\"content\":{\"json\":\"----\\n<div style=\\\"text-align: right\\\"> *Regulatory Compliance Dashboard v.{_template_version}*</div>\\n<div style=\\\"text-align: right\\\"> *Created and maintained by [Eurofiber Cloud Infra](https://github.com/Eurofiber-CloudInfra/azure-compliance-workbooks)*</div>\"},\"name\":\"text - footer\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"azure security center\"]}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#"
}