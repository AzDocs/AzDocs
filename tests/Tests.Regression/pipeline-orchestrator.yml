##############################################################################################################################################################################################################################
#
# AzDocs Regressiontest pipeline
#
# Make sure to have the following vars in your pipeline variables:
#   CompanyName: Your company name. This will be used to randomize url's to avoid collision with other companies' deployments. Please stick to only alphanumeric characters (no hyphens, spaces or dots etc).
#   AzDocsTeamProjectId: Azure DevOps Project ID (GUID) for your AzDocs TeamProject
#   AzDocsBuildDefinitionId: The build definition id of your AzDocs build (int)
#   GatewayIngressDomainName: The domainname you want to use as your entrypoint for this test application. This should be matching the certificate details below.
#   GatewayCertificateSecureFileName: The name of the secure file containing your pfx for the AppGw certificate
#   GatewayCertificatePassword: The password for the AppGw certificate pfx
# 
# And finally add a Service Connection to your Azure DevOps Project to your Azure Subscription with the Service Connection Name "AZDOCSREGRESSIONTESTSUBSCRIPTION".
# Unfortunately theres a technical limitation in Azure DevOps which prevents us from making this a pipeline variable.
#
##############################################################################################################################################################################################################################

parameters:
  - name: ResourceCreation.ResourceGroup.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.LogAnalyticsWorkspace.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.AppInsights.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.Networking.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.AppService.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.Keyvault.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.MSSQL.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.MySQL.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.PostgreSQL.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.RedisCache.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.StorageAccounts.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.FunctionApp.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.ContainerRegistry.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.ContainerInstance.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.ApplicationGateway.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.ServiceBus.Enabled
    type: boolean
    default: true
  - name: ResourceCreation.AppConfiguration.Enabled
    type: boolean
    default: true

    

name: $(date:yyyy.MM.dd)$(rev:.r)-$(Build.SourceBranchName)
trigger:
  branches:
    include:
    #- 'main'
    - more-regression-tests

pool:
    vmImage: 'ubuntu-20.04'

variables:
  # Basic
  - name: ProjectName 
    value: TestApi

  # Switches
  - name: ResourceCreation.ResourceGroup.Enabled
    value: ${{ parameters['ResourceCreation.ResourceGroup.Enabled'] }}
  - name: ResourceCreation.LogAnalyticsWorkspace.Enabled
    value: ${{ parameters['ResourceCreation.LogAnalyticsWorkspace.Enabled'] }}
  - name: ResourceCreation.AppInsights.Enabled
    value: ${{ parameters['ResourceCreation.AppInsights.Enabled'] }}
  - name: ResourceCreation.Networking.Enabled
    value: ${{ parameters['ResourceCreation.Networking.Enabled'] }}
  - name: ResourceCreation.AppService.Enabled
    value: ${{ parameters['ResourceCreation.AppService.Enabled'] }}
  - name: ResourceCreation.Keyvault.Enabled
    value: ${{ parameters['ResourceCreation.Keyvault.Enabled'] }}
  - name: ResourceCreation.MSSQL.Enabled
    value: ${{ parameters['ResourceCreation.MSSQL.Enabled'] }}
  - name: ResourceCreation.MySQL.Enabled
    value: ${{ parameters['ResourceCreation.MySQL.Enabled'] }}
  - name: ResourceCreation.PostgreSQL.Enabled
    value: ${{ parameters['ResourceCreation.PostgreSQL.Enabled'] }}
  - name: ResourceCreation.RedisCache.Enabled
    value: ${{ parameters['ResourceCreation.RedisCache.Enabled'] }}
  - name: ResourceCreation.StorageAccounts.Enabled
    value: ${{ parameters['ResourceCreation.StorageAccounts.Enabled'] }}
  - name: ResourceCreation.FunctionApp.Enabled
    value: ${{ parameters['ResourceCreation.FunctionApp.Enabled'] }}
  - name: ResourceCreation.ContainerRegistry.Enabled
    value: ${{ parameters['ResourceCreation.ContainerRegistry.Enabled'] }}
  - name: ResourceCreation.ContainerInstance.Enabled
    value: ${{ parameters['ResourceCreation.ContainerInstance.Enabled'] }}
  - name: ResourceCreation.ApplicationGateway.Enabled
    value: ${{ parameters['ResourceCreation.ApplicationGateway.Enabled'] }}
  - name: ResourceCreation.ServiceBus.Enabled
    value: ${{ parameters['ResourceCreation.ServiceBus.Enabled'] }}
  - name: ResourceCreation.AppConfiguration.Enabled
    value: ${{ parameters['ResourceCreation.AppConfiguration.Enabled'] }}

  # Tags
  - name: Tag.ApplicationId
    value: 0000
  - name: Tag.ApplicationName 
    value: MyApplication
  - name: Tag.ApplicationOwner 
    value: someuser@company.com
  - name: Tag.AppTechOwner
    value: myteam@company.com
  - name: Tag.BillingIdentifier
    value: 0000
  - name: Tag.BusinessUnit
    value: My Business Unit
  - name: Tag.CostType
    value: Platform
  - name: Tag.Tier 
    value: App

  # Stage Pool
  - name: Stage.Pool
    value: 'ubuntu-20.04'
stages:
- stage: 'Build'
  jobs:
    - job: Build
      displayName: 'Build'
      steps:
       - template: pipeline-build.yml 

- template: pipeline-release.yml
  parameters:
    EnvironmentName: dev
    SubscriptionName: AZDOCSREGRESSIONTESTSUBSCRIPTION